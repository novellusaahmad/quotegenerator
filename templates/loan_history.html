{% extends "base.html" %}

{% block title %}Loan History - Novellus Financial{% endblock %}

{% block body_attr %}class="gold-nav"{% endblock %}

{% block nav_heading %}<span class="navbar-text text-white text-center fw-bold"><i class="fas fa-history me-2"></i>Saved Loan Calculations</span>{% endblock %}

{% block head %}
<link href="{{ url_for('static', filename='css/novellus-theme.css') }}" rel="stylesheet"/>
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/currency-themes.css') }}">
{% endblock %}


{% block content %}
<!-- Notification container for consistent notifications -->
<div id="notification-container" style="position: fixed; top: 80px; right: 20px; z-index: 9999;"></div>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Search and Filter Controls -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search loan names...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="loanTypeFilter">
                                <option value="">All Loan Types</option>
                                <option value="bridge">Bridge Loans</option>
                                <option value="term">Term Loans</option>
                                <option value="development2">Development Loans</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="orgFilter">
                                <option value="">All Organisations</option>
                                <option value="Novellus Limited">Novellus Limited</option>
                                <option value="Novellus Finance limited">Novellus Finance limited</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" id="clearFilters">
                                <i class="fas fa-times me-2"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5">
                <div class="spinner-border text-novellus-gold" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading saved loans...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="alert alert-danger d-none" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">Error loading loans</span>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5 d-none">
                <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Saved Loans Found</h4>
                <p class="text-muted">Start by creating and saving your first loan calculation.</p>
                <a href="{{ url_for('calculator_page') }}" class="btn btn-novellus-gold">
                    <i class="fas fa-plus me-2"></i>Create New Loan
                </a>
            </div>

            <!-- Loans Table -->
            <div id="loansTable" class="d-none">
                <div class="card">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Loan Name</th>
                                    <th>Type</th>
                                    <th>Gross Amount</th>
                                    <th>Interest Rate</th>
                                    <th>Term</th>
                                    <th>Total Interest</th>
                                    <th>Created</th>
                                    <th>Power BI Report</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loansTableBody">
                                <!-- Loan rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loan Details Modal -->
<div class="modal fade" id="loanDetailsModal" tabindex="-1" aria-labelledby="loanDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content h-100" style="overflow-y: auto;">
            <div class="modal-header bg-novellus-navy text-white">
                <h5 class="modal-title" id="loanDetailsModalLabel">Loan Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="loanDetailsContent" style="overflow-y: auto;">
                <div class="text-center py-4">
                    <div class="spinner-border text-novellus-gold" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="downloadDocxButton" class="btn btn-outline-primary" href="#" target="_blank" style="display:none;">
                    <i class="fas fa-file-word me-2"></i>Download DOCX
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-novellus-gold" id="editLoanButton">
                    <i class="fas fa-edit me-2"></i>Edit & Recalculate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS already loaded in base template -->

<!-- Visualization Modals -->
<div class="modal fade modal-edge-to-edge" id="paymentScheduleModal" tabindex="-1" aria-labelledby="paymentScheduleLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-novellus-navy text-white">
        <h5 class="modal-title" id="paymentScheduleLabel">Detailed Payment Schedule</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="detailedPaymentScheduleCard">
          <div>
            <table class="table table-sm" style="width: 100%; border: 1px solid #000; border-collapse: collapse; font-size: 0.875rem;">
              <thead>
                <tr style="background: #f8f9fa; border: 1px solid #000;">
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Period</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Start of Period</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">End of Period</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Days Held</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Capital Outstanding</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Annual Interest %</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Factor P.D.</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Scheduled Repayment</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Total Repayment</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Accrued</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Retained</th>
                  <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Refund</th>
                  <th class="px-2 text-center" style="color: #000; font-weight: bold; font-size: 0.875rem;">Running LTV</th>
                </tr>
              </thead>
              <tbody id="detailedPaymentScheduleBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="exportPaymentScheduleBtn" style="display: none;">Export</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade modal-edge-to-edge" id="trancheScheduleModal" tabindex="-1" aria-labelledby="trancheScheduleLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-novellus-navy text-white">
        <h5 class="modal-title" id="trancheScheduleLabel">Calculation Breakdown</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div>
          <table class="table table-sm" style="width: 100%; border: 1px solid #000; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
              <tr style="background: #f8f9fa; border: 1px solid #000;">
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Start of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">End of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Days Held</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Opening Balance</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Tranche Release</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Calculation</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Principal</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Total Payment</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Closing Balance</th>
                <th class="px-2 text-center" style="color: #000; font-weight: bold; font-size: 0.875rem;">Running LTV</th>
              </tr>
            </thead>
            <tbody id="trancheScheduleBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="exportTrancheScheduleBtn" style="display: none;">Export</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade modal-edge-to-edge" id="loanBreakdownModal" tabindex="-1" aria-labelledby="loanBreakdownLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-novellus-navy text-white">
        <h5 class="modal-title" id="loanBreakdownLabel">Loan Breakdown</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="loanBreakdownChart" class="w-100" style="height:80vh;"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade modal-edge-to-edge" id="balanceModal" tabindex="-1" aria-labelledby="balanceLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-novellus-navy text-white">
        <h5 class="modal-title" id="balanceLabel">Balance Over Time</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="balanceOverTimeChart" class="w-100" style="height:80vh;"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
class LoanHistoryManager {
    constructor() {
        this.loans = [];
        this.filteredLoans = [];
        this.currentLoanId = null;
        this.powerBIReports = {};
        this.loanBreakdownChart = null;

        this.focusNotesAfterLoad = false;

        this.noteStatuses = ['General', 'Call', 'Email', 'Underwriting', 'Legal', 'Completed'];
        this.noteStatusClasses = {
            'General': 'bg-secondary',
            'Call': 'bg-info text-dark',
            'Email': 'bg-primary',
            'Underwriting': 'bg-warning text-dark',
            'Legal': 'bg-danger',
            'Completed': 'bg-success'
        };
        this.init();
    }

    async init() {
        this.bindEvents();
        this.setupModalChartHandlers();
        await this.loadPowerBIReports();
        this.loadLoans();
        // BIRT status check removed for simplified deployment
        
        // Test Bootstrap functionality
        console.log('Bootstrap version:', bootstrap.Tooltip.VERSION);
        console.log('Bootstrap object:', typeof bootstrap);
    }

    bindEvents() {
        // Search and filter events
        document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());
        document.getElementById('loanTypeFilter').addEventListener('change', () => this.applyFilters());
        document.getElementById('orgFilter').addEventListener('change', () => this.applyFilters());
        document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());

        // Edit loan event
        document.getElementById('editLoanButton').addEventListener('click', () => this.editLoan());
    }

    async loadLoans() {
        try {
            console.log('Starting to load loans...');
            this.showState('loading');
            
            console.log('Fetching loans from API...');
            const response = await fetch('/api/saved-loans?_t=' + Date.now()); // Add cache buster
            const data = await response.json();
            
            console.log('API response:', {
                ok: response.ok,
                status: response.status,
                dataKeys: Object.keys(data),
                loansCount: data.loans ? data.loans.length : 0
            });
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load loans');
            }
            
            this.loans = data.loans || [];
            this.filteredLoans = [...this.loans];
            
            console.log(`Loaded ${this.loans.length} loans successfully`);
            
            if (this.loans.length === 0) {
                console.log('No loans found, showing empty state');
                this.showState('empty');
            } else {
                console.log(`Loans found: ${this.loans.length}, showing table and rendering`);
                console.log('First few loan names:', this.loans.slice(0, 3).map(l => l.loan_name));
                this.showState('table');
                this.renderLoansTable();
                this.updateTimestamp();
            }
            
        } catch (error) {
            console.error('Error loading loans:', error);
            this.showError(error.message);
            if (window.notifications) {
                window.notifications.error(`Failed to load loans: ${error.message}`);
            }
        }
    }

    applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const loanTypeFilter = document.getElementById('loanTypeFilter').value.toLowerCase();
        const orgFilter = document.getElementById('orgFilter').value;

        this.filteredLoans = this.loans.filter(loan => {
            const matchesSearch = loan.loan_name.toLowerCase().includes(searchTerm);
            const normalizedType = this.normalizeLoanType(loan.loan_type);
            const matchesType = !loanTypeFilter || normalizedType === loanTypeFilter;
            const loanOrg = loan.currency === 'EUR' ? 'Novellus Finance limited' : 'Novellus Limited';
            const matchesOrg = !orgFilter || loanOrg === orgFilter;
            return matchesSearch && matchesType && matchesOrg;
        });

        if (this.filteredLoans.length === 0 && this.loans.length > 0) {
            this.showState('empty');
        } else {
            this.showState('table');
            this.renderLoansTable();
        }
    }

    // BIRT integration removed for simplified deployment

    // Power BI Report Configuration - Loaded dynamically from API
    powerBIReports = {};
    
    async loadPowerBIReports() {
        try {
            const response = await fetch('/api/powerbi/reports');
            const data = await response.json();
            if (data.success) {
                this.powerBIReports = data.reports;
                console.log('Power BI reports loaded:', this.powerBIReports);
            } else {
                console.error('Failed to load Power BI reports:', data.error);
                // Fallback to default configuration
                this.powerBIReports = {
                    'main': {
                        name: 'Loan Summary Report',
                        baseUrl: 'https://app.powerbi.com/groups/71153f62-9f44-47cd-b6d5-c3e56e8977ba/rdlreports/3bcd8dd2-4773-4372-9a19-1174c108aee5?ctid=16f1922b-4a40-4f3f-8c40-afbd1d4a0e21',
                        icon: 'fas fa-chart-bar'
                    }
                };
            }
        } catch (error) {
            console.error('Error loading Power BI reports:', error);
            // Fallback to default configuration
            this.powerBIReports = {
                'main': {
                    name: 'Loan Summary Report',
                    baseUrl: 'https://app.powerbi.com/groups/71153f62-9f44-47cd-b6d5-c3e56e8977ba/rdlreports/3bcd8dd2-4773-4372-9a19-1174c108aee5?ctid=16f1922b-4a40-4f3f-8c40-afbd1d4a0e21',
                    icon: 'fas fa-chart-bar'
                }
            };
        }
    }

    getPowerBIReports() {
        return this.powerBIReports;
    }

    generatePowerBIUrl(loan, format = 'standard', reportKey = 'main') {
        const reports = this.getPowerBIReports();
        const report = reports[reportKey];
        
        if (!report) {
            console.error(`Power BI report '${reportKey}' not found`);
            return '#';
        }

        const baseUrl = report.baseUrl;
        const parameters = report.parameters || [];
        
        // Build parameter string dynamically
        let paramString = '';
        
        if (parameters.length > 0) {
            parameters.forEach(param => {
                let value = '';
                
                // Get value based on parameter source
                switch(param.source) {
                    case 'loan_name':
                        value = loan.loan_name || param.defaultValue || '';
                        break;
                    case 'currency':
                        // Template based on currency
                        if (param.name.toLowerCase().includes('template')) {
                            value = loan.currency === 'EUR' ? 'Novellus Finance limited' : 'Novellus Limited';
                        } else {
                            value = loan.currency || param.defaultValue || '';
                        }
                        break;
                    case 'gross_amount':
                        value = loan.gross_amount?.toString() || param.defaultValue || '';
                        break;
                    case 'loan_type':
                        value = loan.loan_type || param.defaultValue || '';
                        break;
                    case 'property_value':
                        value = loan.property_value?.toString() || param.defaultValue || '';
                        break;
                    case 'custom':
                    default:
                        value = param.defaultValue || '';
                        break;
                }
                
                if (value) {
                    const encodedValue = encodeURIComponent(value);
                    paramString += `&rp:${param.name}=${encodedValue}`;
                }
            });
        } else {
            // Fallback to legacy parameters if no dynamic parameters configured
            const template = loan.currency === 'EUR' ? 'Novellus Finance limited' : 'Novellus Limited';
            const encodedTemplate = encodeURIComponent(template);
            const encodedLoanName = encodeURIComponent(loan.loan_name);
            paramString = `&rp:Template=${encodedTemplate}&rp:loansummaryloanname=${encodedLoanName}`;
        }
        
        // Debug logging for parameter verification
        console.log('Power BI URL Generation:', {
            reportKey: reportKey,
            reportName: report.name,
            loanName: loan.loan_name,
            currency: loan.currency,
            format: format,
            parametersUsed: parameters.length,
            paramString: paramString
        });
        
        // Build final URL with dynamic parameters
        let finalUrl = baseUrl + paramString;
        
        // Add Power BI specific command if needed
        if (format === 'powerbi') {
            finalUrl = baseUrl + '&rs:Command=Render' + paramString;
        }
        
        console.log(`Generated Power BI URL (${reportKey} - ${format}):`, finalUrl);
        return finalUrl;
    }

    generateReportDropdownItems(loan) {
        const reports = this.getPowerBIReports();
        let items = [];

        console.log('Generating dropdown for loan:', loan.loan_name);
        console.log('Available reports:', Object.keys(reports));
        console.log('Reports object:', reports);

        // Add report links
        Object.keys(reports).forEach(reportKey => {
            const report = reports[reportKey];
            console.log(`Adding report: ${reportKey} - ${report.name}`);
            items.push(`<li><a class="dropdown-item" href="${this.generatePowerBIUrl(loan, 'standard', reportKey)}" target="_blank"><i class="${report.icon} me-2"></i>${report.name}</a></li>`);
        });

        // Add template info
        items.push(`<li><span class="dropdown-item-text small">Template: ${loan.currency === 'EUR' ? 'Novellus Finance limited' : 'Novellus Limited'}</span></li>`);
        items.push(`<li><span class="dropdown-item-text small">Loan: ${loan.loan_name}</span></li>`);

        console.log('Generated dropdown items:', items);
        return items.join('');
    }

    renderNotesSummary(loan) {
        const count = Number(loan.history_note_count || 0);
        const lastNote = loan.last_note || null;
        const countLabel = count === 1 ? 'note' : 'notes';
        const countBadge = `<span class="badge rounded-pill note-count-badge">${count}</span>`;

        let summaryHtml = `<div class="d-flex flex-column gap-1 notes-summary">`;
        summaryHtml += `
            <div class="d-flex align-items-center flex-wrap gap-2">
                ${countBadge}
                <span class="small text-muted">${countLabel}</span>
                ${lastNote ? `<span class="badge ${this.getStatusBadgeClass(lastNote.status || 'General')}">${this.escapeHtml(lastNote.status || 'General')}</span>` : ''}
            </div>
        `;

        if (lastNote) {
            const timestamp = this.formatNoteTimestamp(lastNote.created_at);
            const author = this.escapeHtml(lastNote.author || 'System');
            const previewText = this.escapeHtml(lastNote.text_preview || '');
            summaryHtml += `
                <div class="small text-muted">${author}${timestamp ? ` • ${timestamp}` : ''}</div>
                ${previewText ? `<div class="small text-muted note-preview" title="${previewText}">${this.truncateText(previewText, 120)}</div>` : ''}
            `;
        } else {
            summaryHtml += `<div class="small text-muted">No notes yet</div>`;
        }

        summaryHtml += `
            <button class="btn btn-sm btn-outline-primary note-action-button align-self-start" onclick="loanHistory.viewLoanDetails(${loan.id}, { focusNotes: true })">
                <i class="fas fa-sticky-note me-1"></i>${count ? 'View notes' : 'Add note'}
            </button>
        `;
        summaryHtml += '</div>';

        return summaryHtml;
    }

    truncateText(value, maxLength = 120) {
        if (!value) {
            return '';
        }
        const str = String(value);
        return str.length > maxLength ? `${str.slice(0, maxLength).trim()}…` : str;
    }

    updateLoanCollections(loanId, updater) {
        let updated = false;
        const targetId = Number(loanId);
        const applyUpdate = (collection) => {
            if (!Array.isArray(collection)) {
                return;
            }
            const loan = collection.find(item => Number(item.id) === targetId);
            if (loan) {
                const result = updater(loan);
                if (result !== false) {
                    updated = true;
                }
            }
        };

        applyUpdate(this.loans);
        applyUpdate(this.filteredLoans);
        return updated;
    }

    syncLoanNotesSummary(loanId, notes = [], options = {}) {
        const { reRender = true } = options;
        const noteArray = Array.isArray(notes) ? notes : [];
        const count = noteArray.length;
        const latestNote = count ? noteArray[0] : null;

        const didUpdate = this.updateLoanCollections(loanId, (loan) => {
            const previousCount = Number(loan.history_note_count || 0);
            const previousSummary = JSON.stringify(loan.last_note || null);
            const nextSummary = latestNote
                ? {
                    status: latestNote.status || 'General',
                    author: latestNote.author || 'System',
                    created_at: latestNote.created_at || null,
                    text_preview: this.truncateText(latestNote.text || '', 160)
                }
                : null;

            if (previousCount === count && JSON.stringify(nextSummary) === previousSummary) {
                return false;
            }

            loan.history_note_count = count;
            loan.last_note = nextSummary;
            return true;
        });

        if (didUpdate && reRender) {
            this.renderLoansTable();
        }
    }

    scrollToNotesSection() {
        this.focusNotesAfterLoad = false;
        const card = document.getElementById('loanNotesCard');
        if (!card) {
            return;
        }
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        card.classList.add('note-focus-highlight');
        setTimeout(() => card.classList.remove('note-focus-highlight'), 2000);

        setTimeout(() => {
            const textArea = document.getElementById('loanNoteText');
            if (textArea) {
                textArea.focus();
            }
        }, 350);
    }

    clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('loanTypeFilter').value = '';
        document.getElementById('orgFilter').value = '';
        this.applyFilters();
    }

    updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        const updateTimeEl = document.getElementById('updateTime');
        if (updateTimeEl) {
            updateTimeEl.textContent = timeString;
        }
    }

    renderLoansTable() {
        const tbody = document.getElementById('loansTableBody');
        const totalCount = document.getElementById('totalCount');

        if (totalCount) {
            totalCount.textContent = `${this.filteredLoans.length} loan${this.filteredLoans.length === 1 ? '' : 's'}`;
        }
        
        if (this.filteredLoans.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">No loans match your filters</td></tr>';
            return;
        }

        console.log('Rendering loans table with', this.filteredLoans.length, 'loans');
        console.log('Power BI reports available:', Object.keys(this.powerBIReports));

        const tableHTML = this.filteredLoans.map(loan => `
            <tr>
                <td>
                    <div class="fw-bold text-novellus-navy">${loan.loan_name}</div>
                    <small class="text-muted">v${loan.version}</small>
                </td>
                <td>
                    <span class="badge ${this.getLoanTypeBadgeClass(loan.loan_type)}">
                        ${this.formatLoanType(loan.loan_type)}
                    </span>
                </td>
                <td>
                    <strong>${loan.currency === 'GBP' ? '£' : '€'}${loan.gross_amount.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</strong>
                </td>
                <td>${loan.interest_rate}%</td>
                <td>${loan.loan_term} months</td>
                <td>${loan.currency === 'GBP' ? '£' : '€'}${loan.total_interest.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                <td>
                    <div>${new Date(loan.created_at).toLocaleDateString('en-GB')}</div>
                    <small class="text-muted">${new Date(loan.created_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</small>
                </td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" id="powerbi-dropdown-${loan.id}" data-bs-toggle="dropdown" aria-expanded="false" title="Power BI Reports - ${loan.currency === 'EUR' ? 'Novellus Finance limited' : 'Novellus Limited'}" onclick="console.log('Dropdown clicked for loan:', '${loan.loan_name}')">
                            <i class="fas fa-chart-bar me-1"></i>Reports
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="powerbi-dropdown-${loan.id}">
                            ${this.generateReportDropdownItems(loan)}
                        </ul>
                    </div>
                    <div class="small text-muted mt-1">${loan.currency}</div>
                </td>
                <td>${this.renderNotesSummary(loan)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary bg-white text-dark me-1" onclick="loanHistory.viewLoanDetails(${loan.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <div class="btn-group me-1">
                        <button type="button" class="btn btn-sm btn-outline-secondary bg-white text-dark" onclick="loanHistory.editLoanFromTable(${loan.id})" title="Edit Loan">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary bg-white text-dark" onclick="loanHistory.deleteLoan(${loan.id}, '${loan.loan_name.replace(/'/g, '\\\'')}')" title="Delete Loan">
                            <i class="fas fa-trash"></i>
                        </button>
                </td>
            </tr>
        `).join('');
        
        tbody.innerHTML = tableHTML;
        
        // Manually initialize Bootstrap dropdowns after table render
        setTimeout(() => {
            console.log('Initializing dropdowns manually...');
            const dropdownElements = document.querySelectorAll('[data-bs-toggle="dropdown"]');
            console.log('Found dropdown elements:', dropdownElements.length);
            
            dropdownElements.forEach((element, index) => {
                console.log('Initializing dropdown', index, element.id);
                try {
                    new bootstrap.Dropdown(element);
                    console.log('Dropdown', index, 'initialized successfully');
                } catch (error) {
                    console.error('Error initializing dropdown', index, ':', error);
                }
            });
        }, 100);
    }

    async viewLoanDetails(loanId, options = {}) {
        try {
            this.currentLoanId = loanId;
            const { focusNotes = false } = options;
            this.focusNotesAfterLoad = focusNotes;
            const modal = new bootstrap.Modal(document.getElementById('loanDetailsModal'));
            
            // Show loading state
            document.getElementById('loanDetailsContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-novellus-gold" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            modal.show();
            
            const response = await fetch(`/api/loan/${loanId}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load loan details');
            }
            
            this.renderLoanDetails(data.loan);
            // Enable DOCX download link
            const docxBtn = document.getElementById('downloadDocxButton');
            if (docxBtn) {
                docxBtn.href = `/loan/${loanId}/summary-docx`;
                docxBtn.style.display = 'inline-block';
            }

            if (this.focusNotesAfterLoad) {
                setTimeout(() => this.scrollToNotesSection(), 300);
            }

        } catch (error) {
            this.focusNotesAfterLoad = false;
            console.error('Error loading loan details:', error);
            document.getElementById('loanDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading loan details: ${error.message}
                </div>
            `;
            if (window.notifications) {
                window.notifications.error(`Error loading loan details: ${error.message}`);
            }
        }
    }

    renderLoanDetails(loan) {
        const content = document.getElementById('loanDetailsContent');
        const currencySymbol = loan.currency_symbol || (loan.currency === 'EUR' ? '€' : '£');
        const formatMoney = (val) => `${currencySymbol}${(Number(val) || 0).toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

        
        const toTitleCase = (value) => value ? value.charAt(0).toUpperCase() + value.slice(1) : '';
        const formatPercentage = (value, digits = 2) => `${(Number(value) || 0).toFixed(digits)}%`;
        const buildTable = (rows) => `
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover align-middle mb-0 novellus-detail-table">
                    <tbody>
                        ${rows.filter(Boolean).map(row => `
                            <tr>
                                <th scope="row" class="novellus-detail-label">${row.label}</th>
                                <td class="novellus-detail-value text-end">${row.value}</td>

                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        const loanParametersRows = [
            { label: 'Loan Type', value: toTitleCase(loan.loan_type) },
            { label: 'Amount Input Type', value: loan.amountInputType === 'gross' ? 'Gross Amount' : 'Net Amount' },
            loan.amountInputType === 'gross'
                ? { label: 'User Input Gross Amount', value: formatMoney(loan.grossAmount) }
                : { label: 'User Input Net Amount', value: formatMoney(loan.netAmount) },
            { label: 'Interest Rate (Annual)', value: formatPercentage(loan.interestRate) },
            { label: 'Repayment Option', value: this.formatRepaymentOption(loan.repaymentOption) },
            loan.paymentTiming ? { label: 'Payment Timing', value: loan.paymentTiming === 'advance' ? 'In Advance' : 'In Arrears' } : null,
            loan.paymentFrequency ? { label: 'Payment Frequency', value: toTitleCase(loan.paymentFrequency) } : null,
            loan.capitalRepayment > 0 ? { label: 'Capital Repayment', value: formatMoney(loan.capitalRepayment) } : null,
            loan.flexiblePayment > 0 ? { label: 'Flexible Payment Amount', value: formatMoney(loan.flexiblePayment) } : null,
            { label: 'Arrangement Fee %', value: formatPercentage(loan.arrangementFeePercentage) },
            loan.userInputDay1Advance > 0 ? { label: 'Day 1 Advance (User Input)', value: formatMoney(loan.userInputDay1Advance) } : null
        ];

        const loanSummaryRows = [
            { label: 'Valuation', value: formatMoney(loan.propertyValue) },
            { label: 'Gross Amount', value: formatMoney(loan.grossAmount) },
            { label: 'Date of First Drawdown', value: loan.startDate || '-' },
            { label: 'End Date', value: loan.endDate || '-' },
            { label: 'Term (Months)', value: (Number(loan.loanTerm) || 0).toFixed(2) },
            { label: 'Term (Days)', value: loan.loanTermDays || 0 },
            { label: 'Arrangement Fee', value: `${formatMoney(loan.arrangementFee)} (${formatPercentage(loan.arrangementFeePercentage)})` },
            { label: 'Legal Costs', value: formatMoney(loan.legalFees) },
            { label: 'Site Visit Fee', value: formatMoney(loan.siteVisitFee) },
            { label: 'Title Insurance', value: `${formatMoney(loan.titleInsurance)} (${formatPercentage(loan.titleInsuranceRate, 3)})` },
            { label: 'Total Interest', value: `${formatMoney(loan.totalInterest)} (${formatPercentage(loan.interestRate)})` },
            loan.paymentFrequency === 'quarterly'
                ? { label: 'Quarterly Interest Payment', value: formatMoney(loan.quarterlyInterestPayment) }
                : { label: 'Monthly Interest Payment', value: formatMoney(loan.monthlyInterestPayment) },
            { label: 'Net Advance', value: formatMoney(loan.netAdvance) },
            { label: 'Total Net Advance', value: formatMoney(loan.totalNetAdvance) },
            { label: 'Start LTV', value: `${(loan.startLtv ?? 0).toFixed(1)}%` },
            { label: 'End LTV', value: `${(loan.endLtv ?? 0).toFixed(1)}%` }
        ];

        const scheduleSection = (
            (loan.loan_type === 'development' || loan.loan_type === 'development2') &&
            loan.detailed_tranche_schedule &&
            loan.detailed_tranche_schedule.length > 0
        )
            ? `
        <div class="card shadow-sm mt-4">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-layer-group me-2 text-warning"></i>
                <h6 class="mb-0">Tranche Schedule</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0" style="font-size: 0.8rem;">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="min-width:80px;">Period</th>
                                <th style="min-width:120px;">Start</th>
                                <th style="min-width:120px;">End</th>
                                <th style="min-width:80px;">Days Held</th>
                                <th style="min-width:140px;">Opening Balance</th>
                                <th style="min-width:140px;">Calculation</th>
                                <th style="min-width:140px;">Tranche Release</th>
                                <th style="min-width:120px;">Interest</th>
                                <th style="min-width:120px;">Principal</th>
                                <th style="min-width:140px;">Total Payment</th>
                                <th style="min-width:140px;">Closing Balance</th>
                                <th style="min-width:120px;">Running LTV</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${loan.detailed_tranche_schedule.map((row, index) => {
                                const closing = Number(String(row.closing_balance).replace(/[^0-9.-]/g,'')) || 0;
                                const propertyVal = Number(loan.propertyValue || 0);
                                const runningLtv = propertyVal ? ((closing / propertyVal) * 100).toFixed(2) + '%' : '';
                                return `
                            <tr>
                                <td>${row.period || index + 1}</td>
                                <td>${row.start_period || ''}</td>
                                <td>${row.end_period || ''}</td>
                                <td>${row.days_held ?? ''}</td>
                                <td class="text-end">${formatMoney(row.opening_balance)}</td>
                                <td>${row.interest_calculation || ''}</td>
                                <td class="text-end">${formatMoney(row.tranche_release)}</td>
                                <td class="text-end text-danger">${formatMoney(row.interest)}</td>
                                <td class="text-end text-primary">${formatMoney(row.principal)}</td>
                                <td class="text-end fw-bold text-success">${formatMoney(row.total_payment)}</td>
                                <td class="text-end">${formatMoney(row.closing_balance)}</td>
                                <td class="text-end">${runningLtv}</td>
                            </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        `
            : `
        <div class="card shadow-sm mt-4">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-calendar-alt me-2 text-warning"></i>
                <h6 class="mb-0">Detailed Payment Schedule</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0" style="font-size: 0.8rem;">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="min-width: 80px;">Period</th>
                                <th style="min-width: 120px;">Payment Date</th>
                                <th style="min-width: 140px;">Opening Balance</th>
                                <th style="min-width: 140px;">Tranche Release</th>
                                <th style="min-width: 160px;">Interest Calculation</th>
                                <th style="min-width: 120px;">Interest</th>
                                <th style="min-width: 120px;">Principal</th>
                                <th style="min-width: 140px;">Total Payment</th>
                                <th style="min-width: 140px;">Closing Balance</th>
                                <th style="min-width: 140px;">Balance Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${loan.detailed_payment_schedule.map((payment, index) => `
                            <tr>
                                <td>${payment.period_number || index + 1}</td>
                                <td>${payment.payment_date}</td>
                                <td>${payment.opening_balance}</td>
                                <td>${payment.tranche_release}</td>
                                <td>${payment.interest_calculation}</td>
                                <td class="text-danger">${payment.interest_amount}</td>
                                <td class="text-primary">${payment.principal_payment}</td>
                                <td class="fw-bold text-success">${payment.total_payment}</td>
                                <td>${payment.closing_balance}</td>
                                <td><small class="text-muted">${payment.balance_change}</small></td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        `;

        content.innerHTML = `
        <div class="container-fluid py-2">
            <div class="row g-4 align-items-stretch">
                <div class="col-12 col-xl-8 d-flex flex-column gap-4">
                    <div class="card shadow-sm novellus-detail-card">
                        <div class="card-header d-flex align-items-center">
                            <i class="fas fa-sliders-h me-2 text-warning"></i>
                            <h6 class="mb-0">Loan Parameters</h6>
                        </div>
                        <div class="card-body py-0">
                            ${buildTable(loanParametersRows)}
                        </div>
                    </div>

                    <div class="card shadow-sm novellus-detail-card">
                        <div class="card-header d-flex align-items-center">
                            <i class="fas fa-scroll me-2 text-warning"></i>
                            <h6 class="mb-0">Loan Summary</h6>
                        </div>
                        <div class="card-body py-0">
                            ${buildTable(loanSummaryRows)}
                        </div>
                    </div>
                    <div class="card shadow-sm novellus-detail-card" id="loanNotesCard">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-sticky-note me-2 text-warning"></i>Notes</h6>
                            <small class="text-muted">Track status updates and interactions</small>
                        </div>
                        <div class="card-body">
                            <form id="loanNotesForm" class="row g-2 align-items-start mb-3" data-loan-id="${loan.id}">
                                <div class="col-md-3">
                                    <label for="loanNoteStatus" class="form-label visually-hidden">Note status</label>
                                    <select class="form-select" id="loanNoteStatus" name="status">
                                        <option value="General">General</option>
                                        <option value="Call">Call</option>
                                        <option value="Email">Email</option>
                                        <option value="Underwriting">Underwriting</option>
                                        <option value="Legal">Legal</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-7">
                                    <label for="loanNoteText" class="form-label visually-hidden">Note text</label>
                                    <textarea class="form-control" id="loanNoteText" name="text" rows="2" placeholder="Add a note about this loan..." required></textarea>
                                </div>
                                <div class="col-md-2 d-grid">
                                    <button type="submit" class="btn btn-novellus-gold">
                                        <i class="fas fa-plus me-1"></i>Add Note
                                    </button>
                                </div>
                            </form>
                            <div id="loanNotesLoading" class="text-center text-muted my-3" style="display:none;">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading notes...
                            </div>
                            <div id="loanNotesList" class="list-group"></div>
                            <div id="loanNotesEmpty" class="text-muted text-center mt-3" style="display:none;">No notes yet. Be the first to add one.</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-4 d-flex">
                    <div class="card shadow-sm novellus-chart-card flex-fill">
                        <div class="card-header text-center">
                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2 text-warning"></i>Loan Breakdown</h6>

                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <canvas id="loanBreakdownChart" class="w-100" style="max-height: 420px;"></canvas>
                        </div>
                    </div>

                </div>
            </div>
            ${scheduleSection}
        </div>

        `;
        this.setupLoanNotesSection(loan);
        this.populateDetailedPaymentSchedule(loan);
        this.populateTrancheSchedule(loan);
        this.createLoanBreakdownChart(loan);
        this.createBalanceOverTimeChart(loan);
        this.setupVisualizationButtons(loan);
    }

    getCurrencySymbol(currency) {
        if (!currency) {
            return '£';
        }
        const code = String(currency).trim().toUpperCase();
        switch (code) {
            case 'EUR':
            case '€':
                return '€';
            case 'USD':
            case 'US$':
            case '$':
                return '$';
            case 'GBP':
            case '£':
            default:
                return '£';
        }
    }

    populateDetailedPaymentSchedule(loan) {
        const container = document.getElementById('detailedPaymentScheduleCard');
        const scheduleBody = document.getElementById('detailedPaymentScheduleBody');
        const exportBtn = document.getElementById('exportPaymentScheduleBtn');

        if (!container || !scheduleBody) {
            this.scheduleVisible = false;
            return;
        }

        const schedule = Array.isArray(loan.detailed_payment_schedule) ? loan.detailed_payment_schedule : [];
        const loanType = (loan.loan_type || '').toLowerCase();
        const repaymentOption = loan.repaymentOption || loan.repayment_option || '';
        const hideSchedule = loanType === 'development' || ((loanType === 'term' || loanType === 'bridge') && repaymentOption === 'none');

        if (hideSchedule || schedule.length === 0) {
            container.style.display = 'none';
            if (exportBtn) { exportBtn.style.display = 'none'; }
            this.scheduleVisible = false;
            return;
        }

        container.style.display = 'block';
        if (exportBtn) { exportBtn.style.display = 'none'; }
        scheduleBody.innerHTML = '';

        const headerRow = container.querySelector('thead tr');
        if (headerRow && !this.defaultScheduleHeader) {
            this.defaultScheduleHeader = headerRow.innerHTML;
        }

        const currentSymbol = this.getCurrencySymbol(loan.currency_symbol || loan.currency || 'GBP');

        const parseNumber = (value) => {
            if (typeof value === 'number') {
                return value;
            }
            if (typeof value === 'string') {
                const cleaned = value.replace(/[^0-9.-]/g, '');
                const parsed = parseFloat(cleaned);
                return Number.isFinite(parsed) ? parsed : 0;
            }
            return 0;
        };

        const formatCurrency = (value) => {
            if (value === null || value === undefined) {
                return `${currentSymbol}0.00`;
            }
            if (typeof value === 'number') {
                return `${currentSymbol}${value.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            const stringValue = String(value).trim();
            if (stringValue === '' || stringValue === '—') {
                return stringValue || `${currentSymbol}0.00`;
            }
            return stringValue.replace(/[£€$]/g, currentSymbol);
        };

        const formatText = (value) => {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value).replace(/[£€$]/g, currentSymbol);
        };

        const headers = {
            servicedOnly: `
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Start of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">End of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Days Held</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Opening Balance</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Calculation</th>
                <th class="px-2 text-center" style="color: #000; font-weight: bold; font-size: 0.875rem;">Interest Serviced</th>
            `,
            servicedCapital: `
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Start of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">End of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Days Held</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Capital Outstanding</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Annual Interest %</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Factor P.D.</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Scheduled Repayment</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Total Repayment</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Accrued</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Retained</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Refund</th>
                <th class="px-2 text-center" style="color: #000; font-weight: bold; font-size: 0.875rem;">Running LTV</th>
            `,
            flexible: `
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Start of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">End of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Days Held</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Capital Outstanding</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Annual Interest %</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Factor P.D.</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Total Repayment</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Capital Repayment</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Accrued</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Retained</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Refund</th>
                <th class="px-2 text-center" style="color: #000; font-weight: bold; font-size: 0.875rem;">Running LTV</th>
            `,
            capitalOnly: `
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Start of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">End of Period</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Days Held</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Capital Outstanding</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Annual Interest %</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Factor P.D.</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Scheduled Repayment</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Accrued</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Retained</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Refund</th>
                <th class="px-2 text-center" style="color: #000; font-weight: bold; font-size: 0.875rem;">Running LTV</th>
            `,
            default: `
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Payment Date</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Opening Balance</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Tranche Release</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Calculation</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Interest Saving</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Principal</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Total Payment</th>
                <th class="px-2 text-center" style="border-right: 1px solid #000; color: #000; font-weight: bold; font-size: 0.875rem;">Closing Balance</th>
                <th class="px-2 text-center" style="color: #000; font-weight: bold; font-size: 0.875rem;">Balance Change</th>
            `
        };

        const setHeader = (key) => {
            if (headerRow && headers[key]) {
                headerRow.innerHTML = headers[key];
            }
        };

        if (repaymentOption === 'service_only') {
            setHeader('servicedOnly');
            let totalInterest = 0;
            let totalDays = 0;

            schedule.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.border = '1px solid #000';
                tr.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';

                const startPeriod = row.start_period || '';
                const endPeriod = row.end_period || '';
                const daysHeld = row.days_held ?? '';
                const openingBalance = formatCurrency(row.opening_balance);
                const interestCalculation = formatText(row.interest_calculation);
                const interestAmount = formatCurrency(row.interest_amount);

                totalInterest += parseNumber(row.interest_amount);
                totalDays += parseNumber(daysHeld);

                tr.innerHTML = `
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${startPeriod}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${endPeriod}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${daysHeld}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${openingBalance}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestCalculation}</td>
                    <td class="py-1 px-2 text-end" style="color: #000; font-size: 0.875rem;">${interestAmount}</td>
                `;

                scheduleBody.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.style.border = '1px solid #000';
            totalRow.style.background = '#f8f9fa';
            totalRow.innerHTML = `
                <td colspan="2" class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">Total</td>
                <td class="py-1 px-2 text-center fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">${totalDays}</td>
                <td class="py-1 px-2" style="border-right: 1px solid #000;"></td>
                <td class="py-1 px-2" style="border-right: 1px solid #000;"></td>
                <td class="py-1 px-2 text-end fw-bold" style="color: #000; font-size: 0.875rem;">${currentSymbol}${totalInterest.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            scheduleBody.appendChild(totalRow);

            this.scheduleVisible = true;
            return;
        }

        if (repaymentOption === 'service_and_capital') {
            setHeader('servicedCapital');
            let totalScheduled = 0;
            let totalRepayment = 0;
            let totalAccrued = 0;
            let totalRetained = 0;
            let totalRefund = 0;
            let totalDays = 0;

            schedule.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.border = '1px solid #000';
                tr.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';

                const capitalOutstanding = row.capital_outstanding !== undefined ? formatCurrency(row.capital_outstanding) : '';
                const scheduledRepayment = formatCurrency(row.scheduled_repayment);
                const totalRepaymentValue = formatCurrency(row.total_repayment);
                const interestAccrued = formatCurrency(row.interest_accrued);
                const interestRetained = formatCurrency(row.interest_retained);
                const interestRefund = formatCurrency(row.interest_refund);

                totalScheduled += parseNumber(row.scheduled_repayment);
                totalRepayment += parseNumber(row.total_repayment);
                totalAccrued += parseNumber(row.interest_accrued);
                totalRetained += parseNumber(row.interest_retained);
                totalRefund += parseNumber(row.interest_refund);
                totalDays += parseNumber(row.days_held);

                tr.innerHTML = `
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${index + 1}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.start_period || ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.end_period || ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.days_held ?? ''}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${capitalOutstanding}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.annual_interest_rate ?? ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.interest_pa ?? ''}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${scheduledRepayment}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${totalRepaymentValue}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestAccrued}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestRetained}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestRefund}</td>
                    <td class="py-1 px-2 text-center" style="color: #000; font-size: 0.875rem;">${row.running_ltv ?? ''}</td>
                `;

                scheduleBody.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.style.border = '1px solid #000';
            totalRow.style.background = '#f8f9fa';
            totalRow.innerHTML = `
                <td colspan="3" class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">Total</td>
                <td class="py-1 px-2 text-center fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">${totalDays}</td>
                <td colspan="3" class="py-1 px-2" style="border-right: 1px solid #000;"></td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalScheduled.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRepayment.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalAccrued.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRetained.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRefund.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2"></td>
            `;
            scheduleBody.appendChild(totalRow);

            this.scheduleVisible = true;
            return;
        }

        if (repaymentOption === 'flexible_payment') {
            setHeader('flexible');
            let totalRepayment = 0;
            let totalCapital = 0;
            let totalAccrued = 0;
            let totalRetained = 0;
            let totalRefund = 0;
            let totalDays = 0;

            schedule.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.border = '1px solid #000';
                tr.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';

                const capitalOutstanding = row.capital_outstanding !== undefined ? formatCurrency(row.capital_outstanding) : '';
                const totalRepaymentVal = formatCurrency(row.total_repayment);
                const capitalRepayment = formatCurrency(row.capital_repayment);
                const interestAccrued = formatCurrency(row.interest_accrued);
                const interestRetained = formatCurrency(row.interest_retained);
                const interestRefund = formatCurrency(row.interest_refund);

                totalRepayment += parseNumber(row.total_repayment);
                totalCapital += parseNumber(row.capital_repayment);
                totalAccrued += parseNumber(row.interest_accrued);
                totalRetained += parseNumber(row.interest_retained);
                totalRefund += parseNumber(row.interest_refund);
                totalDays += parseNumber(row.days_held);

                tr.innerHTML = `
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${index + 1}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.start_period || ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.end_period || ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.days_held ?? ''}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${capitalOutstanding}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.annual_interest_rate ?? ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.interest_pa ?? ''}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${totalRepaymentVal}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${capitalRepayment}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestAccrued}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestRetained}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestRefund}</td>
                    <td class="py-1 px-2 text-center" style="color: #000; font-size: 0.875rem;">${row.running_ltv ?? ''}</td>
                `;

                scheduleBody.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.style.border = '1px solid #000';
            totalRow.style.background = '#f8f9fa';
            totalRow.innerHTML = `
                <td colspan="3" class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">Total</td>
                <td class="py-1 px-2 text-center fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">${totalDays}</td>
                <td colspan="3" class="py-1 px-2" style="border-right: 1px solid #000;"></td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRepayment.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalCapital.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalAccrued.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRetained.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRefund.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2"></td>
            `;
            scheduleBody.appendChild(totalRow);

            this.scheduleVisible = true;
            return;
        }

        if (repaymentOption === 'capital_payment_only') {
            setHeader('capitalOnly');
            let totalScheduled = 0;
            let totalAccrued = 0;
            let totalRetained = 0;
            let totalRefund = 0;
            let totalDays = 0;

            schedule.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.border = '1px solid #000';
                tr.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';

                const capitalOutstanding = row.capital_outstanding !== undefined ? formatCurrency(row.capital_outstanding) : '';
                const scheduledRepayment = formatCurrency(row.scheduled_repayment);
                const interestAccrued = formatCurrency(row.interest_accrued);
                const interestRetained = formatCurrency(row.interest_retained);
                const interestRefund = formatCurrency(row.interest_refund);

                totalScheduled += parseNumber(row.scheduled_repayment);
                totalAccrued += parseNumber(row.interest_accrued);
                totalRetained += parseNumber(row.interest_retained);
                totalRefund += parseNumber(row.interest_refund);
                totalDays += parseNumber(row.days_held);

                tr.innerHTML = `
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${index + 1}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.start_period || ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.end_period || ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.days_held ?? ''}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${capitalOutstanding}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.annual_interest_rate ?? ''}</td>
                    <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.interest_pa ?? ''}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${scheduledRepayment}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestAccrued}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestRetained}</td>
                    <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${interestRefund}</td>
                    <td class="py-1 px-2 text-center" style="color: #000; font-size: 0.875rem;">${row.running_ltv ?? ''}</td>
                `;

                scheduleBody.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.style.border = '1px solid #000';
            totalRow.style.background = '#f8f9fa';
            totalRow.innerHTML = `
                <td colspan="3" class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">Total</td>
                <td class="py-1 px-2 text-center fw-bold" style="border-right: 1px solid #000; color: #000; font-size:0.875rem;">${totalDays}</td>
                <td colspan="3" class="py-1 px-2" style="border-right: 1px solid #000;"></td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalScheduled.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalAccrued.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRetained.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2 text-end fw-bold" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${currentSymbol}${totalRefund.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td class="py-1 px-2"></td>
            `;
            scheduleBody.appendChild(totalRow);

            this.scheduleVisible = true;
            return;
        }

        setHeader('default');

        schedule.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.style.border = '1px solid #000';
            tr.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';

            const fixedRow = {
                payment_date: row.payment_date || row.start_period || '',
                opening_balance: formatCurrency(row.opening_balance),
                tranche_release: formatCurrency(row.tranche_release),
                interest_calculation: formatText(row.interest_calculation),
                interest_amount: formatCurrency(row.interest_amount),
                interest_saving: formatCurrency(row.interest_saving || row.interest_refund || ''),
                principal_payment: formatCurrency(row.principal_payment),
                total_payment: formatCurrency(row.total_payment),
                closing_balance: formatCurrency(row.closing_balance),
                balance_change: row.balance_change || ''
            };

            tr.innerHTML = `
                <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.payment_date}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.opening_balance}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.tranche_release}</td>
                <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.interest_calculation}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.interest_amount}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.interest_saving}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.principal_payment}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.total_payment}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${fixedRow.closing_balance}</td>
                <td class="py-1 px-2 text-center" style="color: #000; font-size: 0.875rem;">${fixedRow.balance_change}</td>
            `;

            scheduleBody.appendChild(tr);
        });

        this.scheduleVisible = true;
    }

    populateTrancheSchedule(loan) {
        const body = document.getElementById('trancheScheduleBody');
        const exportBtn = document.getElementById('exportTrancheScheduleBtn');
        if (!body) {
            this.trancheVisible = false;
            return;
        }

        body.innerHTML = '';
        if (exportBtn) { exportBtn.style.display = 'none'; }

        const schedule = Array.isArray(loan.detailed_tranche_schedule) ? loan.detailed_tranche_schedule : [];
        if (!schedule.length) {
            this.trancheVisible = false;
            return;
        }

        const currencySymbol = this.getCurrencySymbol(loan.currency_symbol || loan.currency || 'GBP');
        const formatCurrency = (value) => {
            if (value === null || value === undefined) {
                return `${currencySymbol}0.00`;
            }
            if (typeof value === 'number') {
                return `${currencySymbol}${value.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            const stringValue = String(value).trim();
            if (stringValue === '' || stringValue === '—') {
                return stringValue || `${currencySymbol}0.00`;
            }
            return stringValue.replace(/[£€$]/g, currencySymbol);
        };
        const parseNumber = (value) => {
            if (typeof value === 'number') { return value; }
            if (typeof value === 'string') {
                const parsed = parseFloat(value.replace(/[^0-9.-]/g, ''));
                return Number.isFinite(parsed) ? parsed : 0;
            }
            return 0;
        };

        const propertyValue = Number(loan.propertyValue || loan.property_value || 0);

        schedule.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.style.border = '1px solid #000';
            tr.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';

            const closingBalanceNumeric = parseNumber(row.closing_balance);
            const runningLtv = row.running_ltv || (propertyValue ? `${((closingBalanceNumeric / propertyValue) * 100).toFixed(2)}%` : '');

            tr.innerHTML = `
                <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.period || index + 1}</td>
                <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.start_period || ''}</td>
                <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.end_period || ''}</td>
                <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.days_held ?? ''}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${formatCurrency(row.opening_balance)}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${formatCurrency(row.tranche_release)}</td>
                <td class="py-1 px-2 text-center" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${row.interest_calculation || ''}</td>
                <td class="py-1 px-2 text-end text-danger" style="border-right: 1px solid #000; font-size: 0.875rem;">${formatCurrency(row.interest ?? row.interest_amount)}</td>
                <td class="py-1 px-2 text-end text-primary" style="border-right: 1px solid #000; font-size: 0.875rem;">${formatCurrency(row.principal ?? row.principal_payment)}</td>
                <td class="py-1 px-2 text-end fw-bold text-success" style="border-right: 1px solid #000; font-size: 0.875rem;">${formatCurrency(row.total_payment ?? row.total_repayment)}</td>
                <td class="py-1 px-2 text-end" style="border-right: 1px solid #000; color: #000; font-size: 0.875rem;">${formatCurrency(row.closing_balance)}</td>
                <td class="py-1 px-2 text-center" style="color: #000; font-size: 0.875rem;">${runningLtv}</td>
            `;

            body.appendChild(tr);
        });

        this.trancheVisible = true;
    }

    createBalanceOverTimeChart(loan) {
        const ctx = document.getElementById('balanceOverTimeChart');
        if (!ctx) {
            this.balanceChartAvailable = false;
            return;
        }

        if (this.balanceOverTimeChart) {
            try { this.balanceOverTimeChart.destroy(); } catch (e) {}
            this.balanceOverTimeChart = null;
        }

        const schedule = Array.isArray(loan.detailed_payment_schedule) ? loan.detailed_payment_schedule : [];
        const loanType = (loan.loan_type || '').toLowerCase();
        const repaymentOption = loan.repaymentOption || loan.repayment_option || '';
        const hideAll = loanType === 'bridge' && repaymentOption === 'none';
        const isServicedOnly = repaymentOption === 'service_only';

        if (!schedule.length || hideAll || isServicedOnly) {
            this.balanceChartAvailable = false;
            return;
        }

        const parseValue = (val) => {
            if (typeof val === 'number') {
                return val;
            }
            if (typeof val === 'string') {
                const parsed = parseFloat(val.replace(/[^0-9.-]/g, ''));
                return Number.isFinite(parsed) ? parsed : 0;
            }
            return 0;
        };

        const labels = schedule.map((_, index) => index + 1);
        const balanceData = schedule.map(entry => {
            if (entry.closing_balance !== undefined && entry.closing_balance !== null && entry.closing_balance !== '') {
                return parseValue(entry.closing_balance);
            }
            if (entry.capital_outstanding !== undefined) {
                return parseValue(entry.capital_outstanding);
            }
            return 0;
        });

        let cumulativeAccrued = 0;
        const interestAccruedData = schedule.map(entry => {
            const raw = entry.interest_accrued_raw ?? entry.interest_accrued ?? entry.interest_amount ?? entry.interest;
            const value = parseValue(raw);
            cumulativeAccrued += value;
            return cumulativeAccrued;
        });

        const currencySymbol = this.getCurrencySymbol(loan.currency_symbol || loan.currency || 'GBP');

        const data = {
            labels,
            datasets: [
                {
                    label: 'Remaining Balance',
                    data: balanceData,
                    type: 'bar',
                    backgroundColor: 'rgba(184, 134, 11, 0.6)',
                    borderColor: 'rgba(184, 134, 11, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'Interest Accrued',
                    data: interestAccruedData,
                    type: 'line',
                    borderColor: 'rgba(70, 130, 180, 1)',
                    backgroundColor: 'rgba(70, 130, 180, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(70, 130, 180, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1'
                }
            ]
        };

        const chartConfig = {
            type: 'bar',
            data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                scales: {
                    x: {
                        title: { display: true, text: 'Payment Period' }
                    },
                    y: {
                        title: { display: true, text: `Balance (${currencySymbol})` },
                        beginAtZero: true
                    },
                    y1: {
                        title: { display: true, text: `Interest (${currencySymbol})` },
                        position: 'right',
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Loan Balance & Interest Over Time',
                        font: { size: 14, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${currencySymbol}${context.parsed.y.toLocaleString('en-GB')}`;
                            }
                        }
                    }
                }
            }
        };

        this.balanceOverTimeChart = new Chart(ctx, chartConfig);
        this.balanceChartAvailable = true;
    }

    setupVisualizationButtons(loan) {
        const scheduleBtn = document.getElementById('loanHistoryScheduleBtn');
        const trancheBtn = document.getElementById('loanHistoryTrancheBtn');
        const breakdownBtn = document.getElementById('loanHistoryBreakdownBtn');
        const balanceBtn = document.getElementById('loanHistoryBalanceBtn');

        const loanType = (loan.loan_type || '').toLowerCase();
        const repaymentOption = loan.repaymentOption || loan.repayment_option || '';
        const hideAll = loanType === 'bridge' && repaymentOption === 'none';
        const isServicedOnly = repaymentOption === 'service_only';

        if (scheduleBtn) {
            scheduleBtn.style.display = (!hideAll && this.scheduleVisible) ? 'inline-flex' : 'none';
        }
        if (trancheBtn) {
            trancheBtn.style.display = this.trancheVisible ? 'inline-flex' : 'none';
        }
        if (breakdownBtn) {
            breakdownBtn.style.display = 'inline-flex';
        }
        if (balanceBtn) {
            balanceBtn.style.display = (!hideAll && !isServicedOnly && this.balanceChartAvailable) ? 'inline-flex' : 'none';
        }
    }

    setupModalChartHandlers() {
        const mappings = [
            { modalId: 'loanBreakdownModal', chartGetter: () => this.loanBreakdownChart },
            { modalId: 'balanceModal', chartGetter: () => this.balanceOverTimeChart }
        ];

        mappings.forEach(({ modalId, chartGetter }) => {
            const modalEl = document.getElementById(modalId);
            if (modalEl) {
                modalEl.addEventListener('shown.bs.modal', () => {
                    const chart = chartGetter();
                    if (chart) {
                        chart.resize();
                    }
                });
            }
        });
    }


    createLoanBreakdownChart(loan) {
        const ctx = document.getElementById('loanBreakdownChart');
        if (!ctx) return;

        if (this.loanBreakdownChart) {
            try { this.loanBreakdownChart.destroy(); } catch (e) {}
            this.loanBreakdownChart = null;
        }


        const currency = loan.currency_symbol || (loan.currency === 'EUR' ? '€' : '£');
        const breakdownValues = [
            loan.totalNetAdvance || 0,
            loan.arrangementFee || 0,
            loan.legalFees || 0,
            loan.siteVisitFee || 0,
            loan.titleInsurance || 0,
            loan.totalInterest || 0
        ];


        const data = {
            labels: ['Total Net Advance', 'Arrangement Fee', 'Legal Costs', 'Site Visit Fee', 'Title Insurance', 'Total Interest'],
            datasets: [{
                data: breakdownValues,
                backgroundColor: ['#1E2B3A', '#AD965F', '#E8EBF0', '#3D4F64', '#6C7B7F', '#B0B7C3'],
                borderColor: '#FFFFFF',
                borderWidth: 2,
                hoverOffset: 12
            }]
        };

        const options = {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '58%',
            layout: { padding: 16 },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#1E2B3A',
                        usePointStyle: true,
                        padding: 14,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: '#1E2B3A',
                    titleColor: '#FFFFFF',
                    bodyColor: '#FFFFFF',
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = breakdownValues.reduce((a, b) => a + b, 0);
                            const perc = total ? (value / total * 100).toFixed(1) : 0;
                            return `${label}: ${currency}${value.toLocaleString('en-GB')} (${perc}%)`;
                        }
                    }
                }
            }
        };

        this.loanBreakdownChart = new Chart(ctx, { type: 'doughnut', data, options });
    }
    setupLoanNotesSection(loan) {
        const form = document.getElementById('loanNotesForm');
        const statusSelect = document.getElementById('loanNoteStatus');
        const textArea = document.getElementById('loanNoteText');

        if (!form || !statusSelect || !textArea) {
            console.warn('Loan notes form not found in DOM');
            return;
        }

        form.dataset.loanId = loan.id;
        form.addEventListener('submit', (event) => this.handleAddLoanNote(event));

        this.syncLoanNotesSummary(
            loan.id,
            Array.isArray(loan.history_notes) ? loan.history_notes : [],
            { reRender: false }
        );
        this.renderLoanNotesList(Array.isArray(loan.history_notes) ? loan.history_notes : []);
        this.loadLoanNotes(loan.id);
    }

    async loadLoanNotes(loanId) {
        const loading = document.getElementById('loanNotesLoading');

        if (loading) {
            loading.style.display = 'block';
        }

        try {
            const response = await fetch(`/api/loan/${loanId}/notes`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to load notes');
            }

            const notes = Array.isArray(data.notes) ? data.notes : [];
            this.renderLoanNotesList(notes);
            this.syncLoanNotesSummary(loanId, notes);
        } catch (error) {
            console.error('Failed to load loan notes:', error);
            if (window.notifications) {
                window.notifications.error(`Failed to load notes: ${error.message}`);
            }
        } finally {
            if (loading) {
                loading.style.display = 'none';
            }
        }
    }

    renderLoanNotesList(notes = []) {
        const list = document.getElementById('loanNotesList');
        const empty = document.getElementById('loanNotesEmpty');
        const loading = document.getElementById('loanNotesLoading');

        if (!list || !empty) {
            return;
        }

        if (loading) {
            loading.style.display = 'none';
        }

        list.innerHTML = '';

        if (!notes.length) {
            empty.style.display = 'block';
            return;
        }

        empty.style.display = 'none';
        const items = notes.map((note) => this.renderLoanNoteItem(note)).join('');
        list.innerHTML = items;
    }

    prependLoanNote(note) {
        const list = document.getElementById('loanNotesList');
        const empty = document.getElementById('loanNotesEmpty');
        if (!list) {
            return;
        }

        if (empty) {
            empty.style.display = 'none';
        }

        list.insertAdjacentHTML('afterbegin', this.renderLoanNoteItem(note));
    }

    renderLoanNoteItem(note) {
        const status = note.status || 'General';
        const author = note.author || 'System';
        const timestamp = this.formatNoteTimestamp(note.created_at);
        const safeAuthor = this.escapeHtml(author);
        const safeText = this.escapeHtml(note.text || '');
        const badgeClass = this.getStatusBadgeClass(status);

        return `
            <div class="list-group-item">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge ${badgeClass}">${this.escapeHtml(status)}</span>
                        <span class="fw-semibold">${safeAuthor}</span>
                    </div>
                    <small class="text-muted">${timestamp}</small>
                </div>
                <p class="mb-0 mt-2" style="white-space: pre-wrap;">${safeText}</p>
            </div>
        `;
    }

    getStatusBadgeClass(status) {
        return this.noteStatusClasses[status] || 'bg-secondary';
    }

    formatNoteTimestamp(value) {
        if (!value) {
            return '';
        }

        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return value;
        }

        return date.toLocaleString('en-GB', {
            year: 'numeric',
            month: 'short',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    escapeHtml(value) {
        if (value === null || value === undefined) {
            return '';
        }

        return String(value).replace(/[&<>"']/g, (char) => {
            switch (char) {
                case '&': return '&amp;';
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '"': return '&quot;';
                case "'": return '&#39;';
                default: return char;
            }
        });
    }

    async handleAddLoanNote(event) {
        event.preventDefault();

        const form = event.currentTarget;
        const loanId = form?.dataset?.loanId;
        const statusSelect = document.getElementById('loanNoteStatus');
        const textArea = document.getElementById('loanNoteText');
        const submitButton = form.querySelector('button[type="submit"]');

        if (!loanId || !statusSelect || !textArea) {
            return;
        }

        const text = textArea.value.trim();
        if (!text) {
            if (window.notifications) {
                window.notifications.warning('Please enter a note before adding it.');
            }
            return;
        }

        const status = this.noteStatuses.includes(statusSelect.value) ? statusSelect.value : 'General';
        const originalButtonContent = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving';

        try {
            const response = await fetch(`/api/loan/${loanId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, status })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to add note');
            }

            if (data.note) {
                this.prependLoanNote(data.note);
            }

            textArea.value = '';
            statusSelect.value = status;

            if (window.notifications) {
                window.notifications.success('Note added successfully.');
            }

            this.loadLoanNotes(loanId);
        } catch (error) {
            console.error('Failed to add loan note:', error);
            if (window.notifications) {
                window.notifications.error(`Failed to add note: ${error.message}`);
            }
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonContent;
        }
    }

    editLoan() {
        try {
            if (!this.currentLoanId) {
                if (window.notifications) {
                    window.notifications.error('No loan selected for editing');
                } else {
                    alert('No loan selected');
                }
                return;
            }

            const loan = this.loans.find(l => l.id === this.currentLoanId);
            if (!loan) {
                console.error('Selected loan not found');
                return;
            }

            // Navigate to calculator with loan ID; details loaded from server
            window.location.href = `/calculator?edit=true&loanId=${this.currentLoanId}&loanName=${encodeURIComponent(loan.loan_name)}`;

        } catch (error) {
            console.error('Edit loan error:', error);
            if (window.notifications) {
                window.notifications.error(`Edit loan failed: ${error.message}`);
            }
        }
    }

    editLoanFromTable(loanId) {
        this.currentLoanId = loanId;
        this.editLoan();
    }

    buildEditParams(loan) {
        const formatRate = (rate) => {
            if (rate === undefined || rate === null || rate === '') return '';
            let num = parseFloat(rate);
            if (isNaN(num)) return '';
            num = parseFloat(num.toFixed(4));
            if (Math.abs(num - Math.round(num)) < 0.0005) {
                num = Math.round(num);
            }
            return num.toString();
        };

        const params = {
            // Core loan parameters
            loan_type: loan.loan_type ?? 'bridge',
            amount_input_type: loan.amountInputType ?? loan.amount_input_type ?? 'gross',
            gross_amount_type: loan.grossAmountType ?? loan.gross_amount_type ?? 'fixed',
            rate_input_type: loan.rateInputType ?? loan.rate_input_type ?? 'annual',
            gross_amount: loan.grossAmount ?? loan.gross_amount ?? '',
            net_amount: loan.netAmount ?? loan.net_amount ?? '',
            gross_amount_percentage: loan.grossAmountPercentage ?? loan.gross_amount_percentage ?? '',
            property_value: loan.propertyValue ?? loan.property_value ?? '',
            annual_rate: formatRate(loan.interestRate ?? loan.interest_rate ?? ''),
            monthly_rate: formatRate(loan.monthlyRate ?? loan.monthly_rate ?? ''),
            loan_term: loan.loanTerm ?? loan.loan_term ?? '',
            start_date: loan.startDate ?? loan.start_date ?? '',
            end_date: loan.endDate ?? loan.end_date ?? '',

            // Repayment and fee parameters
            repayment_option: loan.repaymentOption ?? loan.repayment_option ?? 'none',
            arrangement_fee_percentage: loan.arrangementFeePercentage ?? loan.arrangement_fee_percentage ?? '2',
            legal_fees: loan.legalFees ?? loan.legal_fees ?? '1500',
            site_visit_fee: loan.siteVisitFee ?? loan.site_visit_fee ?? '500',
            title_insurance_rate: loan.titleInsuranceRate ?? loan.title_insurance_rate ?? '0.01',

            // Payment parameters
            payment_timing: loan.paymentTiming ?? loan.payment_timing ?? 'advance',
            payment_frequency: loan.paymentFrequency ?? loan.payment_frequency ?? 'monthly',
            capital_repayment: loan.capitalRepayment ?? loan.capital_repayment ?? '',
            flexible_payment: loan.flexiblePayment ?? loan.flexible_payment ?? '',

            // Development loan parameters
            day1_advance: loan.day1Advance ?? loan.day1_advance ?? '',
            tranche_mode: loan.trancheMode ?? loan.tranche_mode ?? 'manual',

            // Currency
            currency: loan.currency ?? 'GBP'
        };

        // Derive additional parameters when not explicitly stored
        if (!params.monthly_rate && params.annual_rate) {
            const annual = parseFloat(params.annual_rate);
            if (!isNaN(annual)) {
                params.monthly_rate = formatRate(annual / 12);
            }
        }

        if (!params.gross_amount_percentage && params.gross_amount && params.property_value) {
            const gross = parseFloat(params.gross_amount);
            const property = parseFloat(params.property_value);
            if (!isNaN(gross) && !isNaN(property) && property !== 0) {
                params.gross_amount_percentage = ((gross / property) * 100).toFixed(4);
            }
        }
        
        // Handle tranches for development loans (both development and development2)
        if ((loan.loan_type === 'development' || loan.loan_type === 'development2') && loan.tranches && Array.isArray(loan.tranches)) {
            loan.tranches.forEach((tranche, index) => {
                params[`tranche_amounts[${index}]`] = tranche.amount ?? '';
                params[`tranche_dates[${index}]`] = tranche.date ?? '';
                params[`tranche_rates[${index}]`] = tranche.rate ?? '';
                params[`tranche_descriptions[${index}]`] = tranche.description ?? '';
            });
        }
        
        console.log('Edit params built:', params);
        return params;
    }

    showState(state) {
        console.log(`Changing loan history state to: ${state}`);
        
        const states = ['loading', 'error', 'empty', 'table'];
        states.forEach(s => {
            let element;
            if (s === 'table') {
                element = document.getElementById('loansTable');
            } else {
                element = document.getElementById(`${s}State`);
            }
            console.log(`State element ${s}:`, element ? 'found' : 'NOT FOUND');
            if (element) {
                element.classList.toggle('d-none', s !== state);
            }
        });
        
        console.log(`Successfully changed to state: ${state}`);
    }

    showError(message) {
        this.showState('error');
        document.getElementById('errorMessage').textContent = message;
    }

    getLoanTypeBadgeClass(type) {
        switch(type.toLowerCase()) {
            case 'bridge':
                return 'bg-warning bg-opacity-25 text-dark';
            case 'term':
            case 'term loan':
            case 'term_loan':
            case 'termloan':
                return 'bg-light text-dark border border-info';
            case 'development':
            case 'development2':
                return 'bg-success bg-opacity-25 text-dark';
            default:
                return 'bg-secondary bg-opacity-25 text-dark';
        }
    }

    formatLoanType(type) {
        const lower = type.toLowerCase();
        if (lower.startsWith('term')) {
            return 'Term';
        }
        if (lower === 'development2' || lower === 'development') {
            return 'Development';
        }
        return lower.charAt(0).toUpperCase() + lower.slice(1);
    }

    normalizeLoanType(type) {
        const lower = type.toLowerCase();
        if (lower.startsWith('term')) {
            return 'term';
        }
        if (lower.startsWith('development')) {
            return 'development2';
        }
        return lower;
    }

    formatRepaymentOption(option) {
        const repaymentMapping = {
            'none': 'Retained Interest',
            'service_only': 'Service Only (Interest Payments)',
            'service_and_capital': 'Service + Capital',
            'flexible_payment': 'Flexible Payment Schedule'
        };
        return repaymentMapping[option] || option;
    }

    async deleteLoan(loanId, loanName) {
        // Use the same notification system as calculator page
        if (window.notifications) {
            // Create a custom confirmation notification
            const confirmMessage = `
                <div style="margin-top: 8px;">
                    <button class="btn btn-sm btn-danger me-2" onclick="loanHistory.performDelete(${loanId}, '${loanName.replace(/'/g, '\\\'')}')" style="font-size: 0.8rem;">Yes, Delete</button>
                    <button class="btn btn-sm btn-secondary" onclick="this.closest('.notification').remove()" style="font-size: 0.8rem;">Cancel</button>
                </div>
            `;
            window.notifications.show(
                `Are you sure you want to delete the loan "${loanName}"? This action cannot be undone.` + confirmMessage,
                'warning',
                15000
            );
        } else {
            if (!confirm(`Are you sure you want to delete the loan "${loanName}"? This action cannot be undone.`)) {
                return;
            }
            this.performDelete(loanId, loanName);
        }
    }

    async performDelete(loanId, loanName) {
        // Close any open notifications
        const notifications = document.querySelectorAll('.notification');
        notifications.forEach(n => n.remove());

        
        try {
            const response = await fetch(`/api/loan/${loanId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to delete loan');
            }

            // Show success notification using notifications system
            if (window.notifications) {
                window.notifications.success(data.message);
            } else {
                alert(data.message);
            }

            // Reload the loans list
            this.loadLoans();

        } catch (error) {
            console.error('Error deleting loan:', error);
            if (window.notifications) {
                window.notifications.error(`Error deleting loan: ${error.message}`);
            } else {
                alert(`Error deleting loan: ${error.message}`);
            }
        }
    }
}

// Initialize the loan history manager
const loanHistory = new LoanHistoryManager();

// Initialize notifications system
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the notification system from calculator
    if (typeof NotificationSystem !== 'undefined') {
        window.notifications = new NotificationSystem();
    }
});
</script>

<style>
.btn-novellus-gold {
    background-color: #B8860B;
    border-color: #B8860B;
    color: white;
}
.btn-novellus-gold:hover {
    background-color: #9A7209;
    border-color: #9A7209;
    color: white;
}
.text-novellus-navy {
    color: #1E2B3A;
}
.bg-novellus-navy {
    background-color: #1E2B3A !important;
}

.notes-summary {
    min-width: 180px;
}

.note-count-badge {
    background-color: rgba(30, 43, 58, 0.1);
    color: #1E2B3A;
    border: 1px solid rgba(30, 43, 58, 0.2);
    font-weight: 600;
}

.note-preview {
    max-width: 220px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.note-action-button {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.note-action-button i {
    font-size: 0.7rem;
}

.note-focus-highlight {
    box-shadow: 0 0 0 0.3rem rgba(184, 134, 11, 0.2);
    border-radius: 0.75rem;
    transition: box-shadow 0.3s ease;
}
.bg-novellus-gold {
    background-color: #B8860B !important;
}
</style>

<!-- Include notifications JavaScript -->
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>

<!-- Currency Theme Manager -->
<script src="{{ url_for('static', filename='js/currency-theme-simple.js') }}"></script>

{% endblock %}
