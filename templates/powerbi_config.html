{% extends "base.html" %}

{% block title %}Power BI Configuration{% endblock %}

{% block nav_heading %}
<span class="navbar-text text-white text-center fw-bold"><i class="fas fa-chart-bar me-2"></i>Power BI Configuration &amp; Scheduler</span>
{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications.css') }}">
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<style>
/* Novellus-themed navigation tabs */
.powerbi-config-page .nav-tabs .nav-link {
    color: var(--novellus-navy);
    font-weight: 600;
}

.powerbi-config-page .nav-tabs .nav-link.active {
    background-color: var(--novellus-gold);
    color: #fff;
    border-color: var(--novellus-gold) var(--novellus-gold) var(--novellus-card-bg);
}

.powerbi-config-page .nav-tabs .nav-link:hover {
    background-color: var(--novellus-gold);
    color: #ffffff;
}

.powerbi-config-page .nav-tabs .nav-link.active:hover {
    background-color: var(--novellus-gold-dark);
    color: #fff;
}

.bg-novellus-navy {
    background-color: var(--novellus-navy) !important;
}

.bg-novellus-gold {
    background-color: var(--novellus-gold) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 powerbi-config-page">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-start mb-3">
                <p class="text-muted mb-0">Dataset refresh, scheduling, and report management</p>
                <div class="d-flex align-items-center gap-2">
                    <div id="schedulerStatusBadge" class="badge bg-light text-dark">
                        <i class="fas fa-clock me-1"></i>Scheduler Inactive
                    </div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addReportModal">
                        <i class="fas fa-plus me-1"></i>Add Report
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="refreshAllReports()" id="refreshAllBtnHeader">
                        <i class="fas fa-sync-alt me-1"></i>Refresh All
                    </button>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="configTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="btn btn-outline-secondary" id="refresh-tab" data-bs-toggle="tab" data-bs-target="#refresh-panel" type="button" role="tab">
                                <i class="fas fa-sync-alt me-1"></i>Dataset Refresh
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="btn btn-outline-secondary" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports-panel" type="button" role="tab">
                                <i class="fas fa-chart-bar me-1"></i>Configured Reports
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="btn btn-outline-secondary" id="schedules-tab" data-bs-toggle="tab" data-bs-target="#schedules-panel" type="button" role="tab">
                                <i class="fas fa-clock me-1"></i>Saved Schedules
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="btn btn-outline-secondary" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab">
                                <i class="fas fa-bookmark me-1"></i>Saved Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="btn btn-outline-secondary" id="snowflake-tab" data-bs-toggle="tab" data-bs-target="#snowflake-panel" type="button" role="tab">
                                <i class="fas fa-database me-1"></i>Snowflake Config
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content">
                        <!-- Dataset Refresh Panel -->
                        <div class="tab-pane fade show active" id="refresh-panel" role="tabpanel">
                            <div class="p-3">
                                <form id="refreshForm" autocomplete="off">
                                    <!-- Compact Credentials Section -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-semibold text-secondary">Username</label>
                                            <input type="email" class="form-control form-control-sm" id="powerbiUsername" 
                                                   placeholder="your.email@company.com" autocomplete="off" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-semibold text-secondary">Password</label>
                                            <div class="input-group input-group-sm">
                                                <input type="password" class="form-control" id="powerbiPassword" 
                                                       placeholder="Enter password" autocomplete="new-password" required>
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('powerbiPassword', this)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-semibold text-secondary">Actions</label>
                                            <div class="d-flex gap-1">
                                                <button type="button" class="btn btn-sm btn-primary" onclick="testConnection()" id="testBtn">
                                                    <i class="fas fa-plug me-1"></i>Test
                                                </button>
                                                <button type="button" class="btn btn-sm btn-primary" onclick="startRefresh()" id="refreshBtn">
                                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                                </button>
                                                <button type="button" class="btn btn-sm btn-primary" onclick="saveReportSettings()" id="saveBtn">
                                                    <i class="fas fa-save me-1"></i>Save
                                                </button>
                                                <button type="button" class="btn btn-sm btn-warning" onclick="testNotification()" id="testNotifyBtn">
                                                    <i class="fas fa-bell me-1"></i>Test
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Dataset URL -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold text-secondary">Dataset URL</label>
                                        <textarea class="form-control form-control-sm" id="datasetUrl" rows="2" 
                                                  placeholder="https://app.powerbi.com/groups/[GROUP_ID]/datasets/[DATASET_ID]" 
                                                  autocomplete="off" required></textarea>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted">Copy from Power BI workspace → Datasets → Your Dataset</small>
                                            <button type="button" class="btn btn-link btn-sm p-0" data-bs-toggle="collapse" data-bs-target="#urlHelp">
                                                <i class="fas fa-question-circle"></i>
                                            </button>
                                        </div>
                                        <div class="collapse mt-2" id="urlHelp">
                                            <div class="alert alert-info py-2 small">
                                                <strong>Quick Guide:</strong> Go to Power BI → Workspace → Datasets → Click your dataset → Copy browser URL
                                            </div>
                                        </div>
                                    </div>
                        
                                    <!-- Compact Scheduled Refresh -->
                                    <div class="card border-0 bg-light">
                                        <div class="card-body p-3">
                                            <div class="row g-3 align-items-end">
                                                <div class="col-md-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="enableScheduledRefresh" onchange="toggleScheduledRefresh()">
                                                        <label class="form-check-label small fw-semibold text-secondary" for="enableScheduledRefresh">
                                                            Scheduled Refresh
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-3" id="intervalSection" style="display: none;">
                                                    <label class="form-label small fw-semibold text-secondary">Refresh Every</label>
                                                    <select class="form-select form-select-sm" id="refreshInterval">
                                                        <option value="1">1 minute</option>
                                                        <option value="2">2 minutes</option>
                                                        <option value="3">3 minutes</option>
                                                        <option value="4">4 minutes</option>
                                                        <option value="5">5 minutes</option>
                                                        <option value="10">10 minutes</option>
                                                        <option value="15">15 minutes</option>
                                                        <option value="20">20 minutes</option>
                                                        <option value="30">30 minutes</option>
                                                        <option value="45">45 minutes</option>
                                                        <option value="60" selected>60 minutes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4" id="scheduleControls" style="display: none;">
                                                    <div class="d-flex gap-1">
                                                        <button type="button" class="btn btn-sm btn-success" onclick="startSchedule()" id="scheduleBtn">
                                                            <i class="fas fa-play me-1"></i>Start
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-danger" onclick="stopSchedule()" id="stopScheduleBtn" style="display: none;">
                                                            <i class="fas fa-stop me-1"></i>Stop
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-primary" onclick="testRefresh()" id="testRefreshBtn">
                                                            <i class="fas fa-vial me-1"></i>Test
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-2" id="scheduleStatusContainer" style="display: none;">
                                                    <div id="scheduleStatus" class="small text-muted">
                                                        <i class="fas fa-clock me-1"></i>Inactive
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Additional Options -->
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div class="form-check">
                                            <input class="form-check-input form-check-input-sm" type="checkbox" id="saveCredentials" checked>
                                            <label class="form-check-label small text-muted" for="saveCredentials">
                                                Save for session (recommended)
                                            </label>
                                        </div>
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="clearForm()" id="clearBtn">
                                                <i class="fas fa-broom me-1"></i>Clear All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-primary" onclick="refreshAllReports()" id="refreshAllBtn">
                                                <i class="fas fa-list-alt me-1"></i>Refresh All
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                
                                <!-- Compact Progress Section -->
                                <div id="refreshStatus" class="mt-3" style="display: none;">
                                    <div class="border rounded p-3 bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="small fw-semibold text-secondary">Refresh Progress</span>
                                            <span class="small text-muted" id="progressText">0%</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 6px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" id="progressBar" style="width: 0%"></div>
                                        </div>
                                        <div id="refreshLogs" class="bg-dark text-light rounded p-2 small" style="height: 120px; overflow-y: auto; font-family: monospace;">
                                            <!-- Logs will appear here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Compact Refresh History -->
                                <div id="refreshHistory" class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-semibold text-secondary small">Recent Activity</span>
                                        <span class="text-muted small" id="historyCount">0 items</span>
                                    </div>
                                    <div id="historyContainer" class="border rounded p-2 bg-light small" style="max-height: 150px; overflow-y: auto;">
                                        <p class="text-muted mb-0 py-2 text-center">No recent activity</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Saved Schedules Panel -->
                        <div class="tab-pane fade" id="schedules-panel" role="tabpanel">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0 text-secondary">
                                        <i class="fas fa-clock me-2"></i>Saved Schedules
                                    </h6>
                                    <button class="btn btn-sm btn-primary" onclick="refreshSchedulesList()">
                                        <i class="fas fa-sync me-1"></i>Refresh
                                    </button>
                                </div>
                                
                                <div id="savedSchedulesContainer">
                                    <div class="text-center py-4 text-muted" id="noSchedulesMessage">
                                        <i class="fas fa-calendar-times fa-2x mb-2 opacity-50"></i>
                                        <p class="mb-0 small">No saved schedules found</p>
                                        <p class="small text-muted">Create a schedule to manage automated Power BI refreshes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configured Reports Panel -->
                        <div class="tab-pane fade" id="reports-panel" role="tabpanel">
                            <div class="p-3">
                                <div id="reportsContainer">
                                    <div class="text-center py-4 text-muted">
                                        <i class="fas fa-chart-bar fa-2x mb-2 opacity-50"></i>
                                        <p class="mb-0 small">No configured reports found</p>
                                        <button class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addReportModal">
                                            <i class="fas fa-plus me-1"></i>Add Your First Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Saved Schedules Panel -->
                        <div class="tab-pane fade" id="schedules-panel" role="tabpanel">
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="fw-semibold text-secondary">Scheduled Power BI Refreshes</span>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="refreshSchedulesList()" id="refreshSchedulesBtn">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh List
                                    </button>
                                </div>
                                <div id="savedSchedulesContainer" class="border rounded p-3 bg-light">
                                    <!-- Schedule cards will be inserted here -->
                                </div>
                                <div id="noSchedulesMessage" class="text-center py-3 text-muted">
                                    <i class="fas fa-clock fa-2x mb-2 opacity-50"></i>
                                    <p class="mb-0 small">No active schedules</p>
                                    <small class="text-muted">Create a schedule using the Dataset Refresh tab</small>
                                </div>
                            </div>
                        </div>

                        <!-- Saved Settings Panel -->
                          <div class="tab-pane fade" id="settings-panel" role="tabpanel">
                              <div class="p-3">
                                  <div class="d-flex justify-content-between align-items-center mb-3">
                                      <span class="fw-semibold text-secondary">Saved Configurations</span>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="clearSavedSettings()" id="clearSettingsBtn">
                                        <i class="fas fa-trash me-1"></i>Clear All
                                    </button>
                                </div>
                                  <div id="savedSettingsContainer" class="border rounded p-3 bg-light">
                                      <div class="text-center py-3 text-muted">
                                          <i class="fas fa-bookmark fa-2x mb-2 opacity-50"></i>
                                          <p class="mb-0 small">No saved settings</p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                        <!-- Snowflake Config Panel -->
                        <div class="tab-pane fade" id="snowflake-panel" role="tabpanel">
                            <div class="p-3">
                                <div id="snowflakeSavedConfig" class="card border mb-3" style="display:none;">
                                    <div class="card-body d-flex justify-content-between align-items-center">
                                        <div id="sfSavedDetails"></div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="testSnowflakeConnection(this)">
                                                <i class="fas fa-vial me-1"></i>Test Connection
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteSnowflakeConfig()">Delete</button>
                                        </div>
                                    </div>
                                </div>
                                <form id="snowflakeForm" autocomplete="off">
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold text-dark">Authentication Method</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="sfAuthType" id="sfAuthTypePassword" value="password" checked>
                                                <label class="form-check-label" for="sfAuthTypePassword">User &amp; Password</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="sfAuthType" id="sfAuthTypePat" value="pat">
                                                <label class="form-check-label" for="sfAuthTypePat">PAT Token</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="sfUserPasswordFields">
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-semibold text-dark">User</label>
                                                <input type="text" class="form-control form-control-sm" id="sfUser">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-semibold text-dark">Password</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="password" class="form-control" id="sfPassword">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('sfPassword', this)">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="sfTokenField" class="mb-3" style="display:none;">
                                        <label class="form-label small fw-semibold text-dark">PAT Token</label>
                                        <textarea class="form-control form-control-sm" id="sfToken" rows="2"></textarea>
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold text-dark">Account</label>
                                            <input type="text" class="form-control form-control-sm" id="sfAccount" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold text-dark">Warehouse</label>
                                            <input type="text" class="form-control form-control-sm" id="sfWarehouse">
                                        </div>
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold text-dark">Database</label>
                                            <input type="text" class="form-control form-control-sm" id="sfDatabase">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold text-dark">Schema</label>
                                            <input type="text" class="form-control form-control-sm" id="sfSchema">
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-sm btn-primary me-2" id="testSnowflakeBtn" onclick="testSnowflakeConnection()">
                                            <i class="fas fa-vial me-1"></i>Test
                                        </button>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="saveSnowflakeConfig()">
                                            <i class="fas fa-save me-1"></i>Save
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Parameter Testing Card - Compact -->
<div class="container-fluid py-2">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            <div class="card mt-3">
                <div class="card-header bg-light py-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-test-tube text-muted me-2"></i>
                        <span class="fw-semibold text-secondary small">Parameter Testing</span>
                    </div>
                </div>
                <div class="card-body py-2">
                    <form id="parameterTestForm">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label small fw-semibold text-secondary">Test Loan Name</label>
                                <input type="text" class="form-control form-control-sm" id="testLoanName" value="Test_Loan_Sample" placeholder="Enter loan name">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-semibold text-secondary">Currency</label>
                                <select class="form-select form-select-sm" id="testCurrency">
                                    <option value="GBP">GBP (Novellus Limited)</option>
                                    <option value="EUR">EUR (Novellus Finance limited)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">URL Format</label>
                                <select class="form-select" id="testFormat">
                                    <option value="standard">Standard Format</option>
                                    <option value="double">Double Encoded</option>
                                    <option value="powerbi">Power BI Specific</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" onclick="testParameters()">
                                <i class="fas fa-external-link-alt me-2"></i>Test URLs
                            </button>
                        </div>
                    </form>
                    <div id="testResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Report Modal -->
<div class="modal fade" id="addReportModal" tabindex="-1" aria-labelledby="addReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-novellus-navy text-white">
                <h5 class="modal-title" id="addReportModalLabel">
                    <i class="fas fa-plus me-2"></i>Add New Power BI Report
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addReportForm">
                    <div class="mb-3">
                        <label for="reportKey" class="form-label">Report Key <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="reportKey" placeholder="e.g., detailed_analysis" required>
                        <div class="form-text">Unique identifier for the report (lowercase, underscores allowed)</div>
                    </div>
                    <div class="mb-3">
                        <label for="reportName" class="form-label">Report Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="reportName" placeholder="e.g., Detailed Analysis Report" required>
                        <div class="form-text">Display name shown in the dropdown</div>
                    </div>
                    <div class="mb-3">
                        <label for="reportUrl" class="form-label">Power BI Report URL <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reportUrl" rows="3" placeholder="https://app.powerbi.com/groups/[GROUP_ID]/rdlreports/[REPORT_ID]?ctid=[TENANT_ID]" required></textarea>
                        <div class="form-text">Full Power BI report URL (parameters will be added automatically)</div>
                    </div>
                    <div class="mb-3">
                        <label for="reportIcon" class="form-label">Icon Class</label>
                        <div class="input-group">
                            <span class="input-group-text"><i id="iconPreview" class="fas fa-chart-bar"></i></span>
                            <input type="text" class="form-control" id="reportIcon" value="fas fa-chart-bar" placeholder="e.g., fas fa-chart-line">
                        </div>
                        <div class="form-text">FontAwesome icon class</div>
                    </div>
                    
                    <!-- Dynamic Parameters Section -->
                    <div class="mb-3">
                        <label class="form-label">Report Parameters</label>
                        <div id="parametersContainer">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Define parameters that will be passed to the Power BI report</small>
                                <button type="button" class="btn btn-primary btn-sm" onclick="addParameter()">
                                    <i class="fas fa-plus me-1"></i>Add Parameter
                                </button>
                            </div>
                            <div id="parametersList">
                                <!-- Parameters will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addReport()">
                    <i class="fas fa-save me-2"></i>Add Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Report Modal -->
<div class="modal fade" id="editReportModal" tabindex="-1" aria-labelledby="editReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-novellus-gold text-dark">
                <h5 class="modal-title" id="editReportModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Power BI Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editReportForm">
                    <input type="hidden" id="editReportKey">
                    <div class="mb-3">
                        <label for="editReportName" class="form-label">Report Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editReportName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editReportUrl" class="form-label">Power BI Report URL <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editReportUrl" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editReportIcon" class="form-label">Icon Class</label>
                        <div class="input-group">
                            <span class="input-group-text"><i id="editIconPreview" class="fas fa-chart-bar"></i></span>
                            <input type="text" class="form-control" id="editReportIcon" value="fas fa-chart-bar">
                        </div>
                    </div>
                    
                    <!-- Dynamic Parameters Section for Edit -->
                    <div class="mb-3">
                        <label class="form-label">Report Parameters</label>
                        <div id="editParametersContainer">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Define parameters that will be passed to the Power BI report</small>
                                <button type="button" class="btn btn-primary btn-sm" onclick="addEditParameter()">
                                    <i class="fas fa-plus me-1"></i>Add Parameter
                                </button>
                            </div>
                            <div id="editParametersList">
                                <!-- Parameters will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateReport()">
                    <i class="fas fa-save me-2"></i>Update Report
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
class PowerBIConfigManager {
    constructor() {
        this.reports = {};
        this.init();
    }

    init() {
        this.loadReports();
        this.bindEvents();
    }

    bindEvents() {
        // Icon preview updates
        document.getElementById('reportIcon').addEventListener('input', (e) => {
            document.getElementById('iconPreview').className = e.target.value || 'fas fa-chart-bar';
        });
        
        document.getElementById('editReportIcon').addEventListener('input', (e) => {
            document.getElementById('editIconPreview').className = e.target.value || 'fas fa-chart-bar';
        });
    }

    loadReports() {
        // Load current reports from the system
        fetch('/api/powerbi/reports')
            .then(response => response.json())
            .then(data => {
                this.reports = data.reports || {};
                this.renderReports();
            })
            .catch(error => {
                console.error('Error loading reports:', error);
                this.showError('Failed to load reports');
            });
    }

    renderReports() {
        const container = document.getElementById('reportsContainer');
        if (Object.keys(this.reports).length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No Power BI Reports Configured</h5>
                    <p class="text-muted">Add your first Power BI report to get started.</p>
                </div>
            `;
            return;
        }

        const reportCards = Object.keys(this.reports).map(key => {
            const report = this.reports[key];
            return `
                <div class="card mb-3" id="report-${key}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="${report.icon} fa-2x text-novellus-gold"></i>
                            </div>
                            <div class="col-md-7">
                                <h5 class="mb-1">${report.name}</h5>
                                <p class="text-muted mb-1 small">Key: <code>${key}</code></p>
                                <p class="text-muted mb-1 small text-truncate">${report.baseUrl}</p>
                                <p class="text-muted mb-0 small">
                                    <i class="fas fa-cogs me-1"></i>
                                    Parameters: ${(report.parameters && report.parameters.length > 0) ? 
                                        report.parameters.map(p => p.name).join(', ') : 
                                        'None configured'}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary" onclick="testReport('${key}')">
                                        <i class="fas fa-external-link-alt me-1"></i>Test
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="editReport('${key}')">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="deleteReport('${key}')">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = reportCards;
    }

    showError(message) {
        this.showNotification(message, 'error');
    }

    showSuccess(message) {
        this.showNotification(message, 'success');
    }
    
    showInfo(message) {
        this.showNotification(message, 'info');
    }
    
    showWarning(message) {
        this.showNotification(message, 'warning');
    }

    showNotification(message, type = 'info') {
        if (Novellus?.utils?.showToast) {
            Novellus.utils.showToast(message, this.getBootstrapType(type));
        }
    }
    
    getBootstrapType(type) {
        switch(type) {
            case 'success': return 'success';
            case 'error': return 'danger';
            case 'warning': return 'warning';
            case 'info': 
            default: return 'info';
        }
    }

}

// Initialize the manager
const configManager = new PowerBIConfigManager();

// Parameter management functions
function addParameter() {
    const container = document.getElementById('parametersList');
    const paramIndex = container.children.length;
    
    const parameterDiv = document.createElement('div');
    parameterDiv.className = 'parameter-item mb-2 p-2 border rounded';
    parameterDiv.innerHTML = `
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Parameter name (e.g., loan_name)" 
                       name="param_name_${paramIndex}">
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" name="param_source_${paramIndex}">
                    <option value="loan_name">Loan Name</option>
                    <option value="currency">Currency</option>
                    <option value="gross_amount">Gross Amount</option>
                    <option value="loan_type">Loan Type</option>
                    <option value="property_value">Property Value</option>
                    <option value="custom">Custom Value</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Default value" 
                       name="param_default_${paramIndex}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="removeParameter(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(parameterDiv);
}

function addEditParameter() {
    const container = document.getElementById('editParametersList');
    const paramIndex = container.children.length;
    
    const parameterDiv = document.createElement('div');
    parameterDiv.className = 'parameter-item mb-2 p-2 border rounded';
    parameterDiv.innerHTML = `
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Parameter name (e.g., loan_name)" 
                       name="edit_param_name_${paramIndex}">
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" name="edit_param_source_${paramIndex}">
                    <option value="loan_name">Loan Name</option>
                    <option value="currency">Currency</option>
                    <option value="gross_amount">Gross Amount</option>
                    <option value="loan_type">Loan Type</option>
                    <option value="property_value">Property Value</option>
                    <option value="custom">Custom Value</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control form-control-sm" 
                       placeholder="Default value" 
                       name="edit_param_default_${paramIndex}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="removeParameter(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(parameterDiv);
}

function removeParameter(button) {
    button.closest('.parameter-item').remove();
}

function collectParameters(prefix = '') {
    const container = document.getElementById(`${prefix}parametersList`);
    const parameters = [];
    
    container.querySelectorAll('.parameter-item').forEach((item, index) => {
        const name = item.querySelector(`[name="${prefix}param_name_${index}"]`)?.value.trim();
        const source = item.querySelector(`[name="${prefix}param_source_${index}"]`)?.value;
        const defaultValue = item.querySelector(`[name="${prefix}param_default_${index}"]`)?.value.trim();
        
        if (name) {
            parameters.push({
                name: name,
                source: source,
                defaultValue: defaultValue || ''
            });
        }
    });
    
    return parameters;
}

function populateParameters(parameters, prefix = '') {
    const container = document.getElementById(`${prefix}parametersList`);
    container.innerHTML = '';
    
    if (parameters && parameters.length > 0) {
        parameters.forEach((param, index) => {
            if (prefix === 'edit') {
                addEditParameter();
            } else {
                addParameter();
            }
            
            const item = container.children[container.children.length - 1];
            item.querySelector(`[name="${prefix}param_name_${index}"]`).value = param.name || '';
            item.querySelector(`[name="${prefix}param_source_${index}"]`).value = param.source || 'loan_name';
            item.querySelector(`[name="${prefix}param_default_${index}"]`).value = param.defaultValue || '';
        });
    }
}

// Global functions
function addReport() {
    const form = document.getElementById('addReportForm');
    const parameters = collectParameters();
    
    const reportData = {
        key: document.getElementById('reportKey').value.trim(),
        name: document.getElementById('reportName').value.trim(),
        baseUrl: document.getElementById('reportUrl').value.trim(),
        icon: document.getElementById('reportIcon').value.trim() || 'fas fa-chart-bar',
        parameters: parameters
    };

    if (!reportData.key || !reportData.name || !reportData.baseUrl) {
        configManager.showError('Please fill in all required fields');
        return;
    }

    fetch('/api/powerbi/reports', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(reportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            configManager.showSuccess('Report added successfully');
            bootstrap.Modal.getInstance(document.getElementById('addReportModal')).hide();
            form.reset();
            configManager.loadReports();
        } else {
            configManager.showError(data.error || 'Failed to add report');
        }
    })
    .catch(error => {
        console.error('Error adding report:', error);
        configManager.showError('Failed to add report');
    });
}

function editReport(key) {
    const report = configManager.reports[key];
    if (!report) return;

    document.getElementById('editReportKey').value = key;
    document.getElementById('editReportName').value = report.name;
    document.getElementById('editReportUrl').value = report.baseUrl;
    document.getElementById('editReportIcon').value = report.icon;
    document.getElementById('editIconPreview').className = report.icon;
    
    // Populate parameters
    populateParameters(report.parameters || [], 'edit');

    new bootstrap.Modal(document.getElementById('editReportModal')).show();
}

function updateReport() {
    const key = document.getElementById('editReportKey').value;
    const parameters = collectParameters('edit');
    
    const reportData = {
        key: key,
        name: document.getElementById('editReportName').value.trim(),
        baseUrl: document.getElementById('editReportUrl').value.trim(),
        icon: document.getElementById('editReportIcon').value.trim() || 'fas fa-chart-bar',
        parameters: parameters
    };

    fetch(`/api/powerbi/reports/${key}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(reportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            configManager.showSuccess('Report updated successfully');
            bootstrap.Modal.getInstance(document.getElementById('editReportModal')).hide();
            configManager.loadReports();
        } else {
            configManager.showError(data.error || 'Failed to update report');
        }
    })
    .catch(error => {
        console.error('Error updating report:', error);
        configManager.showError('Failed to update report');
    });
}

function deleteReport(key) {
    if (!confirm(`Are you sure you want to delete the report "${configManager.reports[key].name}"?`)) {
        return;
    }

    fetch(`/api/powerbi/reports/${key}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            configManager.showSuccess('Report deleted successfully');
            configManager.loadReports();
        } else {
            configManager.showError(data.error || 'Failed to delete report');
        }
    })
    .catch(error => {
        console.error('Error deleting report:', error);
        configManager.showError('Failed to delete report');
    });
}

function testReport(key) {
    const report = configManager.reports[key];
    if (!report) return;

    const testLoan = {
        loan_name: document.getElementById('testLoanName').value || 'Test_Loan_Sample',
        currency: document.getElementById('testCurrency').value || 'GBP'
    };

    const format = document.getElementById('testFormat').value || 'standard';
    
    // Generate test URL (replicating the frontend logic)
    const template = testLoan.currency === 'EUR' ? 'Novellus Finance limited' : 'Novellus Limited';
    const encodedLoanName = encodeURIComponent(testLoan.loan_name);
    const encodedTemplate = encodeURIComponent(template);
    
    let testUrl;
    switch(format) {
        case 'double':
            testUrl = `${report.baseUrl}&rp%253ATemplate=${encodedTemplate}&rp%253Aloansummaryloanname=${encodedLoanName}`;
            break;
        case 'powerbi':
            testUrl = `${report.baseUrl}&rs:ParameterLanguage=&rs:Command=Render&rp:Template=${encodedTemplate}&rp:loansummaryloanname=${encodedLoanName}`;
            break;
        default:
            testUrl = `${report.baseUrl}&rp:Template=${encodedTemplate}&rp:loansummaryloanname=${encodedLoanName}`;
    }

    window.open(testUrl, '_blank');
}

function testParameters() {
    const testLoan = {
        loan_name: document.getElementById('testLoanName').value || 'Test_Loan_Sample',
        currency: document.getElementById('testCurrency').value || 'GBP'
    };

    const format = document.getElementById('testFormat').value || 'standard';
    const resultsContainer = document.getElementById('testResults');
    
    let results = '<div class="alert alert-info"><h6>Generated Test URLs:</h6>';
    
    Object.keys(configManager.reports).forEach(key => {
        const report = configManager.reports[key];
        const template = testLoan.currency === 'EUR' ? 'Novellus Finance limited' : 'Novellus Limited';
        const encodedLoanName = encodeURIComponent(testLoan.loan_name);
        const encodedTemplate = encodeURIComponent(template);
        
        let testUrl;
        switch(format) {
            case 'double':
                testUrl = `${report.baseUrl}&rp%253ATemplate=${encodedTemplate}&rp%253Aloansummaryloanname=${encodedLoanName}`;
                break;
            case 'powerbi':
                testUrl = `${report.baseUrl}&rs:ParameterLanguage=&rs:Command=Render&rp:Template=${encodedTemplate}&rp:loansummaryloanname=${encodedLoanName}`;
                break;
            default:
                testUrl = `${report.baseUrl}&rp:Template=${encodedTemplate}&rp:loansummaryloanname=${encodedLoanName}`;
        }

        results += `
            <div class="mb-2">
                <strong>${report.name}:</strong><br>
                <small class="text-muted">${testUrl}</small><br>
                <a href="${testUrl}" target="_blank" class="btn btn-sm btn-primary mt-1">
                    <i class="fas fa-external-link-alt me-1"></i>Open
                </a>
            </div>
            <hr>
        `;
    });
    
    results += '</div>';
    resultsContainer.innerHTML = results;
}

// Test immediate refresh using final working code
async function testRefresh() {
    const username = document.getElementById('powerbiUsername').value;
    const password = document.getElementById('powerbiPassword').value;
    const datasetUrl = document.getElementById('datasetUrl').value;
    
    if (!username || !password || !datasetUrl) {
        showNotification('Please fill in all Power BI credentials', 'error');
        return;
    }
    
    const testBtn = document.getElementById('testRefreshBtn');
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
    
    try {
        const response = await fetch('/api/powerbi/test-refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                password: password,
                dataset_url: datasetUrl
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Power BI refresh test completed successfully!', 'success');
        } else {
            showNotification(`Test failed: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Test error: ${error.message}`, 'error');
    } finally {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-vial me-1"></i>Test';
    }
}

// Start scheduled refresh
async function startSchedule() {
    const username = document.getElementById('powerbiUsername').value;
    const password = document.getElementById('powerbiPassword').value;
    const datasetUrl = document.getElementById('datasetUrl').value;
    const interval = parseInt(document.getElementById('refreshInterval').value);
    
    if (!username || !password || !datasetUrl) {
        showNotification('Please fill in all Power BI credentials', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/powerbi/start-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                password: password,
                dataset_url: datasetUrl,
                interval: interval
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'success');
            document.getElementById('scheduleBtn').style.display = 'none';
            document.getElementById('stopScheduleBtn').style.display = 'inline-block';
            document.getElementById('scheduleStatus').innerHTML = `<i class="fas fa-clock me-1"></i>Active (${interval}min) - Persistent`;
            if (document.getElementById('schedulerStatusBadge')) {
                document.getElementById('schedulerStatusBadge').className = 'badge bg-success';
                document.getElementById('schedulerStatusBadge').innerHTML = '<i class="fas fa-clock me-1"></i>Active';
            }
            window.schedulerActive = true;
            
            // Start status monitoring
            startStatusMonitoring();
        } else {
            showNotification(`Failed to start schedule: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Schedule error: ${error.message}`, 'error');
    }
}

// Stop scheduled refresh
async function stopSchedule() {
    try {
        const response = await fetch('/api/powerbi/stop-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'info');
            document.getElementById('scheduleBtn').style.display = 'inline-block';
            document.getElementById('stopScheduleBtn').style.display = 'none';
            document.getElementById('scheduleStatus').innerHTML = '<i class="fas fa-clock me-1"></i>Inactive';
            if (document.getElementById('schedulerStatusBadge')) {
                document.getElementById('schedulerStatusBadge').className = 'badge bg-secondary';
                document.getElementById('schedulerStatusBadge').innerHTML = '<i class="fas fa-clock me-1"></i>Inactive';
            }
            window.schedulerActive = false;
            
            // Stop status monitoring
            if (window.statusInterval) {
                clearInterval(window.statusInterval);
            }
        } else {
            showNotification(`Failed to stop schedule: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Stop error: ${error.message}`, 'error');
    }
}

// Monitor schedule status
function startStatusMonitoring() {
    window.statusInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/powerbi/schedule-status');
            const status = await response.json();
            
            if (status.scheduler_running) {
                const nextRun = status.next_run ? new Date(status.next_run).toLocaleTimeString() : 'Unknown';
                const persistentLabel = status.persistent ? ' - Persistent' : '';
                document.getElementById('scheduleStatus').innerHTML = 
                    `<i class="fas fa-clock me-1"></i>Next: ${nextRun}${persistentLabel}`;
            } else {
                // Scheduler stopped externally
                stopSchedule();
            }
        } catch (error) {
            console.error('Status monitoring error:', error);
        }
    }, 30000); // Check every 30 seconds
}

// Initialize scheduler status on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check scheduler status on page load
    fetch('/api/powerbi/schedule-status')
        .then(response => response.json())
        .then(status => {
            if (status.scheduler_running) {
                const interval = status.config && status.config.interval ? status.config.interval : 'Unknown';
                const persistentLabel = status.persistent ? ' - Persistent' : '';
                document.getElementById('scheduleBtn').style.display = 'none';
                document.getElementById('stopScheduleBtn').style.display = 'inline-block';
                document.getElementById('scheduleStatus').innerHTML = `<i class="fas fa-clock me-1"></i>Active (${interval}min)${persistentLabel}`;
                if (document.getElementById('schedulerStatusBadge')) {
                    document.getElementById('schedulerStatusBadge').className = 'badge bg-success';
                    document.getElementById('schedulerStatusBadge').innerHTML = '<i class="fas fa-clock me-1"></i>Active';
                }
                window.schedulerActive = true;
                startStatusMonitoring();
            } else {
                if (document.getElementById('schedulerStatusBadge')) {
                    document.getElementById('schedulerStatusBadge').className = 'badge bg-secondary';
                    document.getElementById('schedulerStatusBadge').innerHTML = '<i class="fas fa-clock me-1"></i>Inactive';
                }
            }
        })
        .catch(error => {
            console.log('Status check error:', error);
        });
});

// Saved Schedules Management Functions
async function refreshSchedulesList() {
    try {
        const response = await fetch('/api/powerbi/schedule-status');
        const status = await response.json();
        
        const container = document.getElementById('savedSchedulesContainer');
        const noSchedulesMessage = document.getElementById('noSchedulesMessage');
        
        if (status.scheduler_running && status.config) {
            // Hide no schedules message
            noSchedulesMessage.style.display = 'none';
            
            // Create schedule card
            const scheduleCard = createScheduleCard(status);
            container.innerHTML = scheduleCard;
        } else {
            // Show no schedules message
            noSchedulesMessage.style.display = 'block';
            container.innerHTML = '';
            container.appendChild(noSchedulesMessage);
        }
    } catch (error) {
        console.error('Failed to refresh schedules list:', error);
        showNotification('Failed to refresh schedules list', 'error');
    }
}

function createScheduleCard(status) {
    const config = status.config || {};
    const nextRun = status.next_run ? new Date(status.next_run).toLocaleString() : 'Unknown';
    const createdAt = config.created_at ? new Date(config.created_at).toLocaleString() : 'Unknown';
    const datasetUrl = config.dataset_url || 'Unknown';
    const shortUrl = datasetUrl.length > 50 ? datasetUrl.substring(0, 50) + '...' : datasetUrl;
    
    return `
        <div class="card border-success" id="scheduleCard">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-clock me-2"></i>
                    <strong>Active Schedule</strong>
                    <span class="badge bg-light text-success ms-2">Running</span>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-light btn-sm" onclick="pauseSchedule()">
                        <i class="fas fa-pause me-1"></i>Pause
                    </button>
                    <button class="btn btn-light btn-sm" onclick="editSchedule()">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="deleteSchedule()">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <small class="text-muted d-block">Refresh Interval</small>
                        <strong>${config.interval || 'Unknown'} minutes</strong>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-block">Next Run</small>
                        <strong>${nextRun}</strong>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-block">Created</small>
                        <span>${createdAt}</span>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-block">Dataset</small>
                        <span title="${datasetUrl}">${shortUrl}</span>
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-sm btn-success" onclick="testScheduledRefresh()">
                        <i class="fas fa-vial me-1"></i>Test Now
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewScheduleLogs()">
                        <i class="fas fa-list me-1"></i>View Logs
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Pause/Resume Schedule
async function pauseSchedule() {
    try {
        const response = await fetch('/api/powerbi/pause-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'info');
            updateScheduleCard('paused');
        } else {
            showNotification(`Failed to pause schedule: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Pause error: ${error.message}`, 'error');
    }
}

async function resumeSchedule() {
    try {
        const response = await fetch('/api/powerbi/resume-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'success');
            updateScheduleCard('running');
        } else {
            showNotification(`Failed to resume schedule: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Resume error: ${error.message}`, 'error');
    }
}

function updateScheduleCard(status) {
    const card = document.getElementById('scheduleCard');
    if (!card) return;
    
    const header = card.querySelector('.card-header');
    const badge = header.querySelector('.badge');
    const pauseBtn = card.querySelector('button[onclick="pauseSchedule()"]');
    
    if (status === 'paused') {
        header.className = 'card-header bg-warning text-dark d-flex justify-content-between align-items-center';
        badge.className = 'badge bg-dark text-warning ms-2';
        badge.textContent = 'Paused';
        pauseBtn.onclick = resumeSchedule;
        pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        pauseBtn.title = 'Resume Schedule';
    } else {
        header.className = 'card-header bg-success text-white d-flex justify-content-between align-items-center';
        badge.className = 'badge bg-light text-success ms-2';
        badge.textContent = 'Running';
        pauseBtn.onclick = pauseSchedule;
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        pauseBtn.title = 'Pause Schedule';
    }
}

// Delete Schedule
async function deleteSchedule() {
    if (!confirm('Are you sure you want to delete this schedule? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/powerbi/stop-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Schedule deleted successfully', 'success');
            refreshSchedulesList();
        } else {
            showNotification(`Failed to delete schedule: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Delete error: ${error.message}`, 'error');
    }
}

// Test scheduled refresh
async function testScheduledRefresh() {
    try {
        const response = await fetch('/api/powerbi/test-refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Manual refresh test completed successfully', 'success');
        } else {
            showNotification(`Test failed: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Test error: ${error.message}`, 'error');
    }
}

// View Schedule Logs
function viewScheduleLogs() {
    // Create modal for log viewing
    const existingModal = document.getElementById('scheduleLogsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div class="modal fade" id="scheduleLogsModal" tabindex="-1" aria-labelledby="scheduleLogsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title" id="scheduleLogsModalLabel">
                            <i class="fas fa-list me-2"></i>Schedule Activity Logs
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="badge bg-success me-2">Live View</span>
                                <small class="text-muted">Auto-refreshes every 5 seconds</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="refreshScheduleLogs()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearScheduleLogs()">
                                    <i class="fas fa-trash me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Log Display Area -->
                        <div id="scheduleLogsContainer" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading logs...
                            </div>
                        </div>
                        
                        <!-- Log Statistics -->
                        <div class="row mt-3 text-center">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <small class="text-muted d-block">Total Refreshes</small>
                                        <strong id="totalRefreshes">0</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <small class="text-muted d-block">Successful</small>
                                        <strong class="text-success" id="successfulRefreshes">0</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <small class="text-muted d-block">Failed</small>
                                        <strong class="text-danger" id="failedRefreshes">0</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <small class="text-muted d-block">Last Run</small>
                                        <strong id="lastRefreshTime">Never</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="downloadLogs()">
                            <i class="fas fa-download me-1"></i>Download Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('scheduleLogsModal'));
    modal.show();
    
    // Start log monitoring
    startLogMonitoring();
    
    // Auto-refresh logs every 5 seconds
    window.logRefreshInterval = setInterval(() => {
        refreshScheduleLogs();
    }, 5000);
    
    // Clean up interval when modal is closed
    document.getElementById('scheduleLogsModal').addEventListener('hidden.bs.modal', function () {
        if (window.logRefreshInterval) {
            clearInterval(window.logRefreshInterval);
        }
    });
}

async function startLogMonitoring() {
    await refreshScheduleLogs();
}

async function refreshScheduleLogs() {
    try {
        const response = await fetch('/api/powerbi/schedule-logs');
        const data = await response.json();
        
        const container = document.getElementById('scheduleLogsContainer');
        if (!container) return;
        
        if (data.success && data.logs) {
            // Format and display logs
            let logHTML = '';
            data.logs.forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const level = log.level.toUpperCase();
                const levelClass = getLevelClass(level);
                
                logHTML += `
                    <div class="log-entry mb-1">
                        <span class="text-muted">${timestamp}</span>
                        <span class="badge ${levelClass} mx-2">${level}</span>
                        <span>${log.message}</span>
                    </div>
                `;
            });
            
            container.innerHTML = logHTML || '<div class="text-center text-muted py-4">No logs available</div>';
            
            // Update statistics
            updateLogStatistics(data.statistics);
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        } else {
            container.innerHTML = '<div class="text-center text-warning py-4">Failed to load logs</div>';
        }
    } catch (error) {
        const container = document.getElementById('scheduleLogsContainer');
        if (container) {
            container.innerHTML = `<div class="text-center text-danger py-4">Error loading logs: ${error.message}</div>`;
        }
    }
}

function getLevelClass(level) {
    switch (level.toLowerCase()) {
        case 'info': return 'bg-primary';
        case 'success': return 'bg-success';
        case 'warning': return 'bg-warning text-dark';
        case 'error': return 'bg-danger';
        case 'debug': return 'bg-secondary';
        default: return 'bg-dark';
    }
}

function updateLogStatistics(stats) {
    if (!stats) return;
    
    const totalElement = document.getElementById('totalRefreshes');
    const successElement = document.getElementById('successfulRefreshes');
    const failedElement = document.getElementById('failedRefreshes');
    const lastElement = document.getElementById('lastRefreshTime');
    
    if (totalElement) totalElement.textContent = stats.total || 0;
    if (successElement) successElement.textContent = stats.successful || 0;
    if (failedElement) failedElement.textContent = stats.failed || 0;
    if (lastElement) {
        lastElement.textContent = stats.lastRun ? 
            new Date(stats.lastRun).toLocaleString() : 'Never';
    }
}

function clearScheduleLogs() {
    if (!confirm('Are you sure you want to clear all schedule logs?')) {
        return;
    }
    
    fetch('/api/powerbi/clear-logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Schedule logs cleared successfully', 'success');
            refreshScheduleLogs();
        } else {
            showNotification(`Failed to clear logs: ${result.error}`, 'error');
        }
    })
    .catch(error => {
        showNotification(`Error clearing logs: ${error.message}`, 'error');
    });
}

function downloadLogs() {
    window.open('/api/powerbi/download-logs', '_blank');
}

// Refresh saved schedules list
async function refreshSchedulesList() {
    try {
        const response = await fetch('/api/powerbi/schedule-status');
        const data = await response.json();
        
        const container = document.getElementById('savedSchedulesContainer');
        const noSchedulesMessage = document.getElementById('noSchedulesMessage');
        
        if (data.scheduler_running && data.config) {
            // Show schedule card
            const scheduleCard = `
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-clock me-2"></i>
                            <strong>Active Schedule</strong>
                            <span class="badge bg-light text-dark ms-2">Every ${data.config.interval} minutes</span>
                        </div>
                        <div class="text-end">
                            <small>✓ Credentials Saved</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <p class="mb-2">
                                    <strong>Dataset:</strong> 
                                    <small class="text-muted">${data.config.dataset_url}</small>
                                </p>
                                <p class="mb-2">
                                    <strong>Next Run:</strong> 
                                    <span class="badge bg-primary">${new Date(data.next_run).toLocaleString()}</span>
                                </p>
                                <p class="mb-0">
                                    <strong>Created:</strong> 
                                    <small class="text-muted">${new Date(data.config.created_at).toLocaleString()}</small>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group-vertical btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewScheduleLogs()">
                                        <i class="fas fa-list me-1"></i>View Logs
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="pauseSchedule()">
                                        <i class="fas fa-pause me-1"></i>Pause
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteSchedule()">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="alert alert-info alert-sm mb-0">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Automation Ready:</strong> This schedule includes saved credentials and will run automatically without manual input.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = scheduleCard;
            noSchedulesMessage.style.display = 'none';
            container.style.display = 'block';
        } else {
            container.innerHTML = '';
            container.style.display = 'none';
            noSchedulesMessage.style.display = 'block';
        }
        
        showNotification('Schedule list refreshed', 'success');
        
    } catch (error) {
        showNotification(`Failed to refresh schedules: ${error.message}`, 'error');
    }
}

// Pause active schedule
async function pauseSchedule() {
    if (!confirm('Are you sure you want to pause the active schedule?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/powerbi/pause-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Schedule paused successfully', 'success');
            refreshSchedulesList();
        } else {
            showNotification(`Failed to pause schedule: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Error pausing schedule: ${error.message}`, 'error');
    }
}

// Delete active schedule
async function deleteSchedule() {
    if (!confirm('Are you sure you want to delete the active schedule? This will remove all saved credentials and configuration.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/powerbi/stop-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Schedule deleted successfully', 'success');
            refreshSchedulesList();
        } else {
            showNotification(`Failed to delete schedule: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Error deleting schedule: ${error.message}`, 'error');
    }
}

// Load schedules when the tab is activated
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh schedules list when the schedules tab is shown
    const schedulesTab = document.querySelector('[data-bs-target="#schedules-panel"]');
    if (schedulesTab) {
        schedulesTab.addEventListener('shown.bs.tab', function () {
            refreshSchedulesList();
        });
    }
    
    // Load schedules on page load
    setTimeout(() => {
        refreshSchedulesList();
    }, 1000);
});

// Initialize schedules list when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Refresh schedules list when schedules tab is shown
    const schedulesTab = document.getElementById('schedules-tab');
    if (schedulesTab) {
        schedulesTab.addEventListener('shown.bs.tab', function () {
            refreshSchedulesList();
        });
    }
});
</script>

<!-- Additional CSS for refresh UI -->
<style>
/* Power BI Configuration Button Consistency */
.powerbi-config-page .btn {
    min-width: 80px;
    height: 38px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 4px;
}

.powerbi-config-page .btn-sm {
    min-width: 70px;
    height: 32px;
    padding: 6px 12px;
    font-size: 13px;
}

.refresh-logs {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
}

.log-entry {
    margin-bottom: 0.25rem;
    padding: 0.25rem 0;
    border-bottom: 1px solid #e9ecef;
}

.log-entry:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.log-timestamp {
    color: #6c757d;
    font-weight: bold;
}

.log-level-INFO {
    color: #0d6efd;
}

.log-level-SUCCESS {
    color: #198754;
    font-weight: bold;
}

.log-level-ERROR {
    color: #dc3545;
    font-weight: bold;
}

.log-level-WARNING {
    color: #fd7e14;
    font-weight: bold;
}

.history-item {
    padding: 0.5rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.history-item:last-child {
    border-bottom: none;
}

.history-status-success {
    color: #198754;
}

.history-status-error {
    color: #dc3545;
}

.history-status-running {
    color: #fd7e14;
}

.saved-setting-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background-color: white;
    transition: all 0.2s ease;
}

.saved-setting-item:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.saved-setting-item:last-child {
    margin-bottom: 0;
}

.setting-name {
    font-weight: bold;
    color: #0d6efd;
}

.setting-details {
    font-size: 0.875rem;
    color: #6c757d;
}

.setting-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}
</style>

<script>
// Power BI Refresh functionality
let currentRefreshId = null;
let refreshInterval = null;
let scheduledRefreshInterval = null;
let scheduledRefreshActive = false;

// Toggle password visibility
function togglePasswordVisibility(fieldId, button) {
    const field = document.getElementById(fieldId);
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Clear the refresh form
function clearForm() {
    // Stop any active scheduled refresh first
    if (scheduledRefreshActive) {
        stopScheduledRefresh();
    }
    
    document.getElementById('refreshForm').reset();
    document.getElementById('refreshStatus').style.display = 'none';
    document.getElementById('refreshLogs').innerHTML = '';
    document.getElementById('progressBar').style.width = '0%';
    
    // Reset scheduled refresh UI
    document.getElementById('enableScheduledRefresh').checked = false;
    toggleScheduledRefresh();
    
    // Clear session storage if credentials were saved
    sessionStorage.removeItem('powerbi_credentials');
    localStorage.removeItem('powerbi_schedule_settings');
    
    showNotification('Form cleared successfully', 'info');
}

// Test Power BI connection
async function testConnection() {
    const username = document.getElementById('powerbiUsername').value.trim();
    const password = document.getElementById('powerbiPassword').value.trim();
    const datasetUrl = document.getElementById('datasetUrl').value.trim();
    
    if (!username || !password || !datasetUrl) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    const testBtn = document.getElementById('testBtn');
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    testBtn.disabled = true;
    
    try {
        const response = await fetch('/api/powerbi/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                password: password,
                dataset_url: datasetUrl
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Connection test successful!', 'success');
        } else {
            showNotification(`Connection test failed: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Connection test error: ${error.message}`, 'error');
    } finally {
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    }
}

// Start Power BI refresh
async function startRefresh() {
    const username = document.getElementById('powerbiUsername').value.trim();
    const password = document.getElementById('powerbiPassword').value.trim();
    const datasetUrl = document.getElementById('datasetUrl').value.trim();
    const saveCredentials = document.getElementById('saveCredentials').checked;
    
    if (!username || !password || !datasetUrl) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Save credentials for session if requested
    if (saveCredentials) {
        sessionStorage.setItem('powerbi_credentials', JSON.stringify({
            username: username,
            dataset_url: datasetUrl
            // Note: We don't save password for security
        }));
    }
    
    const refreshBtn = document.getElementById('refreshBtn');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
    refreshBtn.disabled = true;
    
    // Show refresh status section
    document.getElementById('refreshStatus').style.display = 'block';
    document.getElementById('refreshLogs').innerHTML = '';
    document.getElementById('progressBar').style.width = '0%';
    
    addLogEntry('Starting Power BI dataset refresh...', 'INFO');
    
    try {
        const response = await fetch('/api/powerbi/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                password: password,
                dataset_url: datasetUrl
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addLogEntry('Refresh request submitted successfully', 'SUCCESS');
            updateProgressBar(25);
            
            // Start polling for status updates
            startStatusPolling();
            
            // Add to refresh history
            addRefreshHistory('Running', new Date().toISOString());
            
            showNotification('Refresh started successfully!', 'success');
        } else {
            addLogEntry(`Refresh failed: ${result.error}`, 'ERROR');
            showNotification(`Refresh failed: ${result.error}`, 'error');
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        }
    } catch (error) {
        addLogEntry(`Refresh error: ${error.message}`, 'ERROR');
        showNotification(`Refresh error: ${error.message}`, 'error');
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

// Add log entry to the refresh logs
function addLogEntry(message, level = 'INFO') {
    const logsContainer = document.getElementById('refreshLogs');
    const timestamp = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-level-${level}">${level}:</span>
        <span class="log-message">${message}</span>
    `;
    
    logsContainer.appendChild(logEntry);
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

// Update progress bar
function updateProgressBar(percentage) {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = `${percentage}%`;
    progressBar.setAttribute('aria-valuenow', percentage);
}

// Start polling for refresh status
function startStatusPolling() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    let progress = 25;
    let step = 0;
    
    refreshInterval = setInterval(() => {
        step++;
        
        // Simulate progress updates
        if (step === 1) {
            addLogEntry('Initializing Chrome browser...', 'INFO');
            updateProgressBar(35);
        } else if (step === 2) {
            addLogEntry('Logging into Power BI...', 'INFO');
            updateProgressBar(50);
        } else if (step === 3) {
            addLogEntry('Navigating to dataset...', 'INFO');
            updateProgressBar(65);
        } else if (step === 4) {
            addLogEntry('Triggering dataset refresh...', 'INFO');
            updateProgressBar(80);
        } else if (step === 5) {
            addLogEntry('Monitoring refresh progress...', 'INFO');
            updateProgressBar(90);
        } else if (step >= 6) {
            // Simulate completion
            addLogEntry('Dataset refresh completed successfully!', 'SUCCESS');
            updateProgressBar(100);
            
            // Re-enable refresh button
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Start Refresh';
            refreshBtn.disabled = false;
            
            // Update refresh history
            updateRefreshHistory('Completed');
            
            clearInterval(refreshInterval);
            refreshInterval = null;
            
            showNotification('Power BI refresh completed successfully!', 'success');
        }
    }, 3000); // Update every 3 seconds
}

// Add refresh to history
function addRefreshHistory(status, timestamp) {
    const historyContainer = document.getElementById('historyContainer');
    
    // Remove "no activity" message if present
    if (historyContainer.querySelector('.text-muted')) {
        historyContainer.innerHTML = '';
    }
    
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.id = `history-${Date.now()}`;
    
    const statusClass = status === 'Completed' ? 'history-status-success' : 
                       status === 'Error' ? 'history-status-error' : 'history-status-running';
    
    const refreshType = status === 'Scheduled' ? 'Scheduled refresh activated' : 'Dataset refresh initiated';
    const badgeColor = status === 'Completed' ? 'bg-success' : 
                      status === 'Error' ? 'bg-danger' : 
                      status === 'Scheduled' ? 'bg-info' : 'bg-warning';
    
    historyItem.innerHTML = `
        <div>
            <strong>${new Date(timestamp).toLocaleString()}</strong>
            <div class="text-muted small">${refreshType}</div>
        </div>
        <div>
            <span class="badge ${badgeColor}">${status}</span>
        </div>
    `;
    
    historyContainer.insertBefore(historyItem, historyContainer.firstChild);
}

// Update existing refresh history entry
function updateRefreshHistory(newStatus) {
    const historyContainer = document.getElementById('historyContainer');
    const latestItem = historyContainer.firstElementChild;
    
    if (latestItem) {
        const badge = latestItem.querySelector('.badge');
        if (badge) {
            badge.textContent = newStatus;
            badge.className = `badge ${newStatus === 'Completed' ? 'bg-success' : 
                                     newStatus === 'Error' ? 'bg-danger' : 'bg-warning'}`;
        }
    }
}

// Show notification
function showNotification(message, type = 'info') {
    if (Novellus?.utils?.showToast) {
        Novellus.utils.showToast(message, type === 'error' ? 'danger' : type);
    }
}

// This function was moved to the enhanced DOMContentLoaded below

// Load refresh history from local storage
function loadRefreshHistory() {
    const history = localStorage.getItem('powerbi_refresh_history');
    if (history) {
        try {
            const historyData = JSON.parse(history);
            const historyContainer = document.getElementById('historyContainer');
            
            if (historyData.length > 0) {
                historyContainer.innerHTML = '';
                historyData.forEach(item => {
                    addRefreshHistory(item.status, item.timestamp);
                });
            }
        } catch (error) {
            console.error('Error loading refresh history:', error);
        }
    }
}

// Save refresh history to local storage
function saveRefreshHistory() {
    const historyItems = Array.from(document.querySelectorAll('.history-item')).map(item => {
        const timestamp = item.querySelector('strong').textContent;
        const badge = item.querySelector('.badge');
        const status = badge ? badge.textContent : 'Unknown';
        
        return { timestamp, status };
    });
    
    localStorage.setItem('powerbi_refresh_history', JSON.stringify(historyItems.slice(0, 10))); // Keep last 10 items
}

// Save history when page unloads
window.addEventListener('beforeunload', saveRefreshHistory);

// Scheduled Refresh Functions
function toggleScheduledRefresh() {
    const checkbox = document.getElementById('enableScheduledRefresh');
    const intervalSection = document.getElementById('intervalSection');
    const scheduleControls = document.getElementById('scheduleControls');
    const statusContainer = document.getElementById('scheduleStatusContainer');
    
    if (checkbox.checked) {
        intervalSection.style.display = 'block';
        scheduleControls.style.display = 'block';
        statusContainer.style.display = 'block';
    } else {
        intervalSection.style.display = 'none';
        scheduleControls.style.display = 'none';
        statusContainer.style.display = 'none';
        
        // Stop any active scheduled refresh
        if (scheduledRefreshActive) {
            stopScheduledRefresh();
        }
    }
}

function startScheduledRefresh() {
    const username = document.getElementById('powerbiUsername').value.trim();
    const password = document.getElementById('powerbiPassword').value.trim();
    const datasetUrl = document.getElementById('datasetUrl').value.trim();
    const intervalMinutes = parseInt(document.getElementById('refreshInterval').value);
    
    // Validate inputs
    if (!username || !password || !datasetUrl) {
        showNotification('Please fill in all required credentials first', 'error');
        return;
    }
    
    if (!intervalMinutes || intervalMinutes < 1 || intervalMinutes > 60) {
        showNotification('Please enter a valid interval between 1 and 60 minutes', 'error');
        return;
    }
    
    // Stop any existing scheduled refresh
    if (scheduledRefreshInterval) {
        clearInterval(scheduledRefreshInterval);
    }
    
    // Start scheduled refresh
    scheduledRefreshActive = true;
    const intervalMs = intervalMinutes * 60 * 1000; // Convert to milliseconds
    
    scheduledRefreshInterval = setInterval(() => {
        addLogEntry(`Scheduled refresh triggered (every ${intervalMinutes} minutes)`, 'INFO');
        startRefresh();
    }, intervalMs);
    
    // Update UI
    document.getElementById('scheduleBtn').style.display = 'none';
    document.getElementById('stopScheduleBtn').style.display = 'inline-block';
    document.getElementById('scheduleStatus').innerHTML = `
        <small class="text-success">
            <i class="fas fa-check-circle me-1"></i>
            Active (every ${intervalMinutes} min)
        </small>
    `;
    
    // Save schedule settings
    localStorage.setItem('powerbi_schedule_settings', JSON.stringify({
        enabled: true,
        interval: intervalMinutes,
        started: new Date().toISOString()
    }));
    
    showNotification(`Scheduled refresh started - will run every ${intervalMinutes} minutes`, 'success');
    addLogEntry(`Scheduled refresh activated with ${intervalMinutes}-minute interval`, 'SUCCESS');
    
    // Add to history
    addRefreshHistory('Scheduled', new Date().toISOString());
}

function stopScheduledRefresh() {
    if (scheduledRefreshInterval) {
        clearInterval(scheduledRefreshInterval);
        scheduledRefreshInterval = null;
    }
    
    scheduledRefreshActive = false;
    
    // Update UI
    document.getElementById('scheduleBtn').style.display = 'inline-block';
    document.getElementById('stopScheduleBtn').style.display = 'none';
    document.getElementById('scheduleStatus').innerHTML = `
        <small class="text-muted">
            <i class="fas fa-pause-circle me-1"></i>
            Stopped
        </small>
    `;
    
    // Clear saved settings
    localStorage.removeItem('powerbi_schedule_settings');
    
    showNotification('Scheduled refresh stopped', 'info');
    addLogEntry('Scheduled refresh deactivated', 'INFO');
}

// Load scheduled refresh settings on page load
function loadScheduledRefreshSettings() {
    const settings = localStorage.getItem('powerbi_schedule_settings');
    if (settings) {
        try {
            const scheduleData = JSON.parse(settings);
            if (scheduleData.enabled) {
                // Restore UI state
                document.getElementById('enableScheduledRefresh').checked = true;
                document.getElementById('refreshInterval').value = scheduleData.interval;
                toggleScheduledRefresh();
                
                // Show that schedule was previously active but is now stopped
                document.getElementById('scheduleStatus').innerHTML = `
                    <small class="text-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Stopped (was active)
                    </small>
                `;
                
                addLogEntry(`Previous schedule found (${scheduleData.interval} min interval) - click Start Schedule to resume`, 'INFO');
            }
        } catch (error) {
            console.error('Error loading scheduled refresh settings:', error);
        }
    }
}

// Auto-save credentials as user types
function autoSaveCredentials() {
    if (document.getElementById('saveCredentials').checked) {
        const username = document.getElementById('powerbiUsername').value;
        const password = document.getElementById('powerbiPassword').value;
        const datasetUrl = document.getElementById('datasetUrl').value;
        
        sessionStorage.setItem('powerbi_username', username);
        sessionStorage.setItem('powerbi_password', password);
        sessionStorage.setItem('powerbi_dataset_url', datasetUrl);
    }
}

// Enhanced DOMContentLoaded to include scheduled refresh settings
document.addEventListener('DOMContentLoaded', function() {
    // Load saved credentials from session storage
    const savedUsername = sessionStorage.getItem('powerbi_username');
    const savedPassword = sessionStorage.getItem('powerbi_password');
    const savedDatasetUrl = sessionStorage.getItem('powerbi_dataset_url');
    
    if (savedUsername) document.getElementById('powerbiUsername').value = savedUsername;
    if (savedPassword) document.getElementById('powerbiPassword').value = savedPassword;
    if (savedDatasetUrl) document.getElementById('datasetUrl').value = savedDatasetUrl;
    
    // Add auto-save listeners
    document.getElementById('powerbiUsername').addEventListener('input', autoSaveCredentials);
    document.getElementById('powerbiPassword').addEventListener('input', autoSaveCredentials);
    document.getElementById('datasetUrl').addEventListener('input', autoSaveCredentials);
    
    // Load refresh history from local storage
    loadRefreshHistory();
    
    // Load scheduled refresh settings
    loadScheduledRefreshSettings();

    // Load saved report settings
    loadSavedSettings();

    // Load Snowflake configuration
    loadSnowflakeConfig();
});

// Save and Load Report Settings Functions
function saveReportSettings() {
    const username = document.getElementById('powerbiUsername').value.trim();
    const password = document.getElementById('powerbiPassword').value.trim();
    const datasetUrl = document.getElementById('datasetUrl').value.trim();
    const enableScheduled = document.getElementById('enableScheduledRefresh').checked;
    const interval = document.getElementById('refreshInterval').value;
    
    if (!username || !datasetUrl) {
        showNotification('Please enter at least username and dataset URL to save settings', 'error');
        return;
    }
    
    // Generate a setting name based on dataset URL
    const urlParts = datasetUrl.split('/');
    const settingName = `Dataset_${urlParts[urlParts.length - 2] || 'Unknown'}_${Date.now()}`;
    
    const settings = {
        name: settingName,
        username: username,
        dataset_url: datasetUrl,
        scheduled_refresh: enableScheduled,
        refresh_interval: interval,
        saved_at: new Date().toISOString(),
        // Don't save password for security
        has_password: !!password
    };
    
    // Load existing saved settings
    const savedSettings = JSON.parse(localStorage.getItem('powerbi_saved_settings') || '[]');
    
    // Add new setting
    savedSettings.unshift(settings);
    
    // Keep only last 10 settings
    const trimmedSettings = savedSettings.slice(0, 10);
    
    // Save to localStorage
    localStorage.setItem('powerbi_saved_settings', JSON.stringify(trimmedSettings));
    
    // Refresh display
    loadSavedSettings();
    
    showNotification('Report settings saved successfully!', 'success');
    addLogEntry(`Settings saved as: ${settingName}`, 'SUCCESS');
}

function loadSavedSettings() {
    const savedSettings = JSON.parse(localStorage.getItem('powerbi_saved_settings') || '[]');
    const container = document.getElementById('savedSettingsContainer');
    
    if (savedSettings.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0">No saved settings</p>';
        return;
    }
    
    container.innerHTML = savedSettings.map((setting, index) => `
        <div class="saved-setting-item">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="setting-name">${setting.name}</div>
                    <div class="setting-details">
                        <div><strong>Username:</strong> ${setting.username}</div>
                        <div><strong>Dataset:</strong> ${setting.dataset_url.substring(0, 50)}${setting.dataset_url.length > 50 ? '...' : ''}</div>
                        <div><strong>Scheduled:</strong> ${setting.scheduled_refresh ? `Yes (${setting.refresh_interval} min)` : 'No'}</div>
                        <div><strong>Saved:</strong> ${new Date(setting.saved_at).toLocaleString()}</div>
                        <div><strong>Password:</strong> ${setting.has_password ? 'Saved (will need re-entry)' : 'Not saved'}</div>
                    </div>
                </div>
                <div class="setting-actions">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadSetting(${index})">
                        <i class="fas fa-upload me-1"></i>Load
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="refreshFromSetting(${index})">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteSetting(${index})">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function loadSetting(index) {
    const savedSettings = JSON.parse(localStorage.getItem('powerbi_saved_settings') || '[]');
    const setting = savedSettings[index];
    
    if (!setting) {
        showNotification('Setting not found', 'error');
        return;
    }
    
    // Load the setting into the form
    document.getElementById('powerbiUsername').value = setting.username;
    document.getElementById('datasetUrl').value = setting.dataset_url;
    document.getElementById('enableScheduledRefresh').checked = setting.scheduled_refresh;
    document.getElementById('refreshInterval').value = setting.refresh_interval || 15;
    
    // Update UI visibility
    toggleScheduledRefresh();
    
    showNotification('Settings loaded successfully! Please enter your password.', 'success');
    addLogEntry(`Loaded settings: ${setting.name}`, 'INFO');
    
    // Focus on password field
    document.getElementById('powerbiPassword').focus();
}

function refreshFromSetting(index) {
    const savedSettings = JSON.parse(localStorage.getItem('powerbi_saved_settings') || '[]');
    const setting = savedSettings[index];
    
    if (!setting) {
        showNotification('Setting not found', 'error');
        return;
    }
    
    // Check if current form has the password
    const currentPassword = document.getElementById('powerbiPassword').value.trim();
    if (!currentPassword) {
        showNotification('Please enter your password in the form first, then try refreshing', 'error');
        return;
    }
    
    // Load setting temporarily and trigger refresh
    const originalUsername = document.getElementById('powerbiUsername').value;
    const originalDatasetUrl = document.getElementById('datasetUrl').value;
    
    // Set the setting values
    document.getElementById('powerbiUsername').value = setting.username;
    document.getElementById('datasetUrl').value = setting.dataset_url;
    
    // Trigger refresh
    addLogEntry(`Refreshing using saved setting: ${setting.name}`, 'INFO');
    startRefresh();
    
    // Restore original values if they were different
    if (originalUsername !== setting.username || originalDatasetUrl !== setting.dataset_url) {
        setTimeout(() => {
            if (confirm('Do you want to keep the loaded setting values in the form?')) {
                // Keep the loaded values
            } else {
                // Restore original values
                document.getElementById('powerbiUsername').value = originalUsername;
                document.getElementById('datasetUrl').value = originalDatasetUrl;
            }
        }, 1000);
    }
}

function deleteSetting(index) {
    const savedSettings = JSON.parse(localStorage.getItem('powerbi_saved_settings') || '[]');
    const setting = savedSettings[index];
    
    if (!setting) {
        showNotification('Setting not found', 'error');
        return;
    }
    
    if (confirm(`Are you sure you want to delete the setting "${setting.name}"?`)) {
        savedSettings.splice(index, 1);
        localStorage.setItem('powerbi_saved_settings', JSON.stringify(savedSettings));
        loadSavedSettings();
        showNotification('Setting deleted successfully', 'success');
        addLogEntry(`Deleted setting: ${setting.name}`, 'INFO');
    }
}

function refreshAllReports() {
    const username = document.getElementById('powerbiUsername').value.trim();
    const password = document.getElementById('powerbiPassword').value.trim();
    
    if (!username || !password) {
        showNotification('Please enter your credentials first', 'error');
        return;
    }
    
    // Get all saved settings
    const savedSettings = JSON.parse(localStorage.getItem('powerbi_saved_settings') || '[]');
    
    if (savedSettings.length === 0) {
        showNotification('No saved settings found to refresh', 'error');
        return;
    }
    
    const refreshAllBtn = document.getElementById('refreshAllBtn');
    const originalText = refreshAllBtn.innerHTML;
    refreshAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing All...';
    refreshAllBtn.disabled = true;
    
    addLogEntry(`Starting refresh for ${savedSettings.length} saved report settings`, 'INFO');
    
    // Refresh each setting sequentially with delay
    let currentIndex = 0;
    const refreshNext = () => {
        if (currentIndex >= savedSettings.length) {
            // All done
            refreshAllBtn.innerHTML = originalText;
            refreshAllBtn.disabled = false;
            showNotification(`All ${savedSettings.length} reports refreshed successfully!`, 'success');
            addLogEntry('All report refreshes completed', 'SUCCESS');
            return;
        }
        
        const setting = savedSettings[currentIndex];
        addLogEntry(`Refreshing report ${currentIndex + 1}/${savedSettings.length}: ${setting.name}`, 'INFO');
        
        // Set the dataset URL for this refresh
        const originalDatasetUrl = document.getElementById('datasetUrl').value;
        document.getElementById('datasetUrl').value = setting.dataset_url;
        
        // Start refresh for this setting
        startRefresh();
        
        // Move to next after delay
        currentIndex++;
        setTimeout(() => {
            refreshNext();
        }, 5000); // 5 second delay between refreshes
    };
    
    // Start the refresh chain
    refreshNext();
}

function saveSnowflakeConfig() {
    const payload = getSnowflakeFormData();
    if (!payload) return;

    fetch('/api/snowflake/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            localStorage.setItem('snowflake_config', JSON.stringify(payload));
            showNotification('Snowflake configuration saved', 'success');
            loadSnowflakeConfig();
        } else {
            showNotification(`Failed to save Snowflake config: ${data.error}`, 'error');
        }
    })
    .catch(err => {
        showNotification(`Failed to save Snowflake config: ${err.message}`, 'error');
    });
}

function loadSnowflakeConfig() {
    fetch('/api/snowflake/config')
        .then(resp => resp.json())
        .then(data => {
            let cfg = data.config || {};
            if (!cfg.method) {
                const stored = localStorage.getItem('snowflake_config');
                if (stored) {
                    cfg = JSON.parse(stored);
                }
            }
            const form = document.getElementById('snowflakeForm');
            const savedDiv = document.getElementById('snowflakeSavedConfig');
            if (!cfg.method) {
                form.reset();
                savedDiv.style.display = 'none';
                form.style.display = 'block';
                toggleSfAuthFields();
                return;
            }
            document.getElementById('sfAccount').value = cfg.account || '';
            document.getElementById('sfWarehouse').value = cfg.warehouse || '';
            document.getElementById('sfDatabase').value = cfg.database || '';
            document.getElementById('sfSchema').value = cfg.schema || '';
            if (cfg.method === 'pat' || cfg.method === 'token') {
                document.getElementById('sfAuthTypePat').checked = true;
                document.getElementById('sfToken').value = cfg.token || '';
            } else {
                document.getElementById('sfAuthTypePassword').checked = true;
                document.getElementById('sfUser').value = cfg.user || '';
                document.getElementById('sfPassword').value = cfg.password || '';
            }
            toggleSfAuthFields();
            const summary = (cfg.method === 'pat' || cfg.method === 'token')
                ? `Token connection for account ${cfg.account}`
                : `User ${cfg.user} on account ${cfg.account}`;
            document.getElementById('sfSavedDetails').textContent = summary;
            savedDiv.style.display = 'flex';
        });
}

function deleteSnowflakeConfig() {
    if (!confirm('Delete Snowflake configuration?')) return;
    fetch('/api/snowflake/config', { method: 'DELETE' })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                localStorage.removeItem('snowflake_config');
                showNotification('Snowflake configuration deleted', 'success');
                loadSnowflakeConfig();
            } else {
                showNotification(`Failed to delete config: ${data.error}`, 'error');
            }
        })
        .catch(err => {
            showNotification(`Failed to delete config: ${err.message}`, 'error');
        });
}

function toggleSfAuthFields() {
    const method = document.querySelector('input[name="sfAuthType"]:checked').value;
    document.getElementById('sfUserPasswordFields').style.display = method === 'password' ? 'block' : 'none';
    document.getElementById('sfTokenField').style.display = method === 'pat' ? 'block' : 'none';
}

document.querySelectorAll('input[name="sfAuthType"]').forEach(el => {
    el.addEventListener('change', toggleSfAuthFields);
});

async function testSnowflakeConnection(btnElem) {
    const btn = btnElem || document.getElementById('testSnowflakeBtn');
    if (!btn) return;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
    try {
        const payload = getSnowflakeFormData();
        if (!payload) throw new Error('Missing required fields');
        const resp = await fetch('/api/snowflake/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.success) {
            showNotification('Snowflake connection successful', 'success');
        } else {
            showNotification(`Connection failed: ${data.error}`, 'error');
        }
    } catch (err) {
        showNotification(`Connection error: ${err.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

function getSnowflakeFormData() {
    const method = document.querySelector('input[name="sfAuthType"]:checked').value;
    const payload = {
        method: method,
        account: document.getElementById('sfAccount').value.trim(),
        warehouse: document.getElementById('sfWarehouse').value.trim(),
        database: document.getElementById('sfDatabase').value.trim(),
        schema: document.getElementById('sfSchema').value.trim()
    };
    if (method === 'pat') {
        payload.token = document.getElementById('sfToken').value.trim();
        if (!payload.token || !payload.account) {
            showNotification('Token and account are required', 'error');
            return null;
        }
    } else {
        payload.user = document.getElementById('sfUser').value.trim();
        payload.password = document.getElementById('sfPassword').value.trim();
        if (!payload.user || !payload.password || !payload.account) {
            showNotification('User, password and account are required', 'error');
            return null;
        }
    }
    return payload;
}

// Enhanced clear form to handle saved settings
function clearSavedSettings() {
    if (confirm('Are you sure you want to clear all saved settings? This cannot be undone.')) {
        localStorage.removeItem('powerbi_saved_settings');
        loadSavedSettings();
        showNotification('All saved settings cleared', 'info');
        addLogEntry('Cleared all saved settings', 'INFO');
    }
}
</script>
{% endblock %}