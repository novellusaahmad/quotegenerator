{% extends "base.html" %}

{% block title %}Loan History Detail - Novellus Financial{% endblock %}

{% block body_attr %}class="gold-nav"{% endblock %}

{% block nav_heading %}
<span class="navbar-text text-white text-center fw-bold"><i class="fas fa-file-invoice-dollar me-2"></i>Loan History Detail</span>
{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/novellus-theme.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/currency-themes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications.css') }}">
<style>
    body.gold-nav {
        background-color: #0b0b16;
        color: #f0f0f0;
    }

    .loan-detail-page .page-title {
        font-weight: 600;
        color: #ffffff;
    }

    .loan-detail-page .subtitle {
        color: rgba(255, 255, 255, 0.65);
        font-size: 0.9rem;
    }

    .loan-detail-actions .btn {
        border-radius: 30px;
        padding: 0.45rem 1.25rem;
        font-weight: 600;
        text-transform: none;
    }

    .loan-detail-actions .btn-outline-light {
        border-color: rgba(255,255,255,0.35);
        color: #ffffff;
    }

    .loan-detail-actions .btn-outline-light:hover {
        background: rgba(255,255,255,0.1);
        color: #ffffff;
    }

    .loan-detail-card {
        background: rgba(12, 18, 32, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 14px;
        box-shadow: 0 18px 30px rgba(2, 8, 20, 0.45);
        overflow: hidden;
    }

    .loan-detail-card .card-header {
        background: linear-gradient(135deg, #1E2B3A 0%, #2C3E50 100%);
        color: #f9f9f9;
        font-weight: 600;
        letter-spacing: 0.4px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .loan-detail-card .table {
        margin-bottom: 0;
        color: #f8f9fa;
    }

    .loan-detail-card .table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.03);
    }

    .loan-detail-card .table td {
        border-top: 1px solid rgba(255,255,255,0.04);
        padding: 0.6rem 0.85rem;
        vertical-align: middle;
        color: #f8f9fa;
    }

    .loan-detail-card .table td:first-child {
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
        width: 55%;
    }

    .loan-detail-card .table td:last-child {
        text-align: right;
        font-weight: 600;
        color: #ffffff;
    }

    .loan-highlight-badge {
        background: rgba(180, 155, 92, 0.15);
        color: #e6c98d;
        border: 1px solid rgba(180, 155, 92, 0.35);
        border-radius: 30px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.7px;
    }

    .chart-card {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        box-shadow: 0 22px 45px rgba(0, 0, 0, 0.45);
    }

    .chart-card .card-header {
        border-bottom: 1px solid rgba(255,255,255,0.08);
        background: linear-gradient(135deg, rgba(13,27,43,0.95) 0%, rgba(21,34,54,0.95) 100%);
        color: #fefefe;
        font-weight: 600;
    }


    .chart-card .card-body {
        padding: 1.25rem 1.4rem;
        min-height: 280px;
    }

    .chart-card canvas {
        min-height: 280px;

    }

    .loan-detail-loading,
    .loan-detail-error {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 16px;
        padding: 2.5rem;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.05);
        color: rgba(255,255,255,0.85);
    }

    .loan-detail-error {
        border: 1px solid rgba(220, 53, 69, 0.35);
        color: #f8d7da;
    }

    .loan-detail-page .info-chip {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 50px;
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.75);
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    .chart-grid {
        display: grid;

        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;

    }

    @media (min-width: 992px) {
        .loan-summary-column {
            overflow-x: auto;
        }

        .loan-summary-column .loan-detail-card .table td {
            white-space: nowrap;
        }
    }

    @media (max-width: 991.98px) {
        .loan-detail-actions {
            margin-top: 1rem;
        }
    }
</style>
{% endblock %}

{% block main_class %}container-fluid loan-detail-page py-4{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="row g-3 align-items-center flex-lg-row-reverse">
        <div class="col-lg-7 col-md-12">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center align-items-start justify-content-lg-end gap-3">
                <div>
                    <a href="{{ url_for('loan_history') }}" class="btn btn-outline-light"><i class="fas fa-arrow-left me-2"></i>Back to Loan History</a>
                </div>
                <div class="loan-detail-actions d-flex flex-wrap gap-2">
                    <a id="downloadDocxButton" class="btn btn-outline-primary d-flex align-items-center" href="#" target="_blank">
                        <i class="fas fa-file-word me-2"></i>Download DOCX
                    </a>
                    <button id="downloadExcelButton" class="btn btn-outline-info d-flex align-items-center">
                        <i class="fas fa-file-excel me-2"></i>Export Excel
                    </button>
                    <button id="editLoanButton" class="btn btn-novellus-gold d-flex align-items-center">
                        <i class="fas fa-edit me-2"></i>Edit &amp; Recalculate
                    </button>
                </div>
            </div>
        </div>
        <div class="col-lg-5 col-md-12 text-lg-start">
            <h2 class="page-title mb-1">Loan: <span id="loanNameDisplay">{{ loan_name or 'Loading...' }}</span></h2>
            <div class="subtitle">
                <span class="info-chip"><i class="fas fa-id-badge"></i>ID: {{ loan_id }}</span>
                <span class="info-chip"><i class="fas fa-calendar-alt"></i><span id="loanCreatedDisplay">Loading…</span></span>
                <span class="info-chip"><i class="fas fa-coins"></i><span id="loanCurrencyDisplay">-</span></span>
            </div>
        </div>
    </div>
</div>

<div id="loanDetailLoading" class="loan-detail-loading my-5" role="status">
    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
    <div>Retrieving saved loan data…</div>
</div>

<div id="loanDetailError" class="loan-detail-error my-5 d-none" role="alert"></div>

<div id="loanDetailContent" class="d-none">
    <div class="row g-4">
        <div class="col-lg-4 col-xl-3 loan-summary-column">

            <div class="loan-detail-card mb-3">

                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list-alt me-2"></i>Loan Parameters</span>
                    <span id="loanTypeBadge" class="loan-highlight-badge">-</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-borderless align-middle">
                        <tbody id="loanParametersBody"></tbody>
                    </table>
                </div>
            </div>


            <div class="loan-detail-card mb-3">

                <div class="card-header"><i class="fas fa-redo-alt me-2"></i>Repayment Profile</div>
                <div class="card-body p-0">
                    <table class="table table-borderless align-middle">
                        <tbody id="repaymentProfileBody"></tbody>
                    </table>
                </div>
            </div>


            <div class="loan-detail-card mb-3">

                <div class="card-header"><i class="fas fa-receipt me-2"></i>Fees &amp; Costs</div>
                <div class="card-body p-0">
                    <table class="table table-borderless align-middle">
                        <tbody id="feesSectionBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="loan-detail-card mb-0">

                <div class="card-header"><i class="fas fa-clipboard-check me-2"></i>Loan Summary</div>
                <div class="card-body p-0">
                    <table class="table table-borderless align-middle">
                        <tbody id="loanSummaryBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-xl-9">
            <div class="chart-grid">
                <div class="card chart-card">
                    <div class="card-header"><i class="fas fa-chart-pie me-2"></i>Loan Summary Breakdown</div>
                    <div class="card-body">
                        <canvas id="loanBreakdownChart"></canvas>
                    </div>
                </div>
                <div class="card chart-card" id="interestPrincipalCard">
                    <div class="card-header"><i class="fas fa-balance-scale me-2"></i>Interest vs Principal</div>
                    <div class="card-body">
                        <canvas id="interestPrincipalChart"></canvas>
                    </div>
                </div>

                <div class="card chart-card d-none" id="ltvChartCard">
                    <div class="card-header"><i class="fas fa-gauge-high me-2"></i>LTV Position</div>
                    <div class="card-body">
                        <canvas id="loanLtvChart"></canvas>
                    </div>
                </div>

                <div class="card chart-card" id="paymentScheduleCard">
                    <div class="card-header"><i class="fas fa-stream me-2"></i>Payment Schedule Overview</div>
                    <div class="card-body">
                        <canvas id="paymentScheduleChart"></canvas>
                    </div>
                </div>
                <div class="card chart-card" id="balanceChartCard">
                    <div class="card-header"><i class="fas fa-chart-line me-2"></i>Balance &amp; Interest Over Time</div>
                    <div class="card-body">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
                <div class="card chart-card d-none" id="trancheReleaseCard">
                    <div class="card-header"><i class="fas fa-layer-group me-2"></i>Tranche Release Timeline</div>
                    <div class="card-body">
                        <canvas id="trancheReleaseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
class LoanHistoryDetailPage {
    constructor(options) {
        this.loanId = options.loanId;
        this.loanName = options.loanName || '';
        this.currency = 'GBP';
        this.currencySymbol = '£';
        this.loanData = null;

        this.inputData = {};
        this.scheduleData = [];
        this.hasDevelopmentTranches = false;
        this.loanType = '';

        this.init();
    }

    async init() {
        try {
            await this.loadLoan();
        } catch (error) {
            this.showError(error.message || 'Unable to load loan details');
        }
    }

    async loadLoan() {
        const loadingEl = document.getElementById('loanDetailLoading');
        const contentEl = document.getElementById('loanDetailContent');
        const errorEl = document.getElementById('loanDetailError');

        loadingEl.classList.remove('d-none');
        contentEl.classList.add('d-none');
        errorEl.classList.add('d-none');

        try {
            const response = await fetch(`/api/loan/${this.loanId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Failed to fetch loan details');
            }


            this.loanData = data.loan || {};
            this.inputData = data.input_data || {};
            this.loanName = this.loanData.loan_name || this.inputData.loan_name || this.loanName;
            this.currency = this.loanData.currency || this.inputData.currency || 'GBP';
            this.currencySymbol = this.loanData.currency_symbol
                || this.inputData.currency_symbol
                || this.inputData.currencySymbol
                || (this.currency === 'EUR' ? '€' : '£');

            const rawSchedule = this.loanData.detailed_payment_schedule
                || this.inputData.detailed_payment_schedule
                || [];
            this.scheduleData = this.parseScheduleData(rawSchedule);

            const typeValue = this.getFromSources(['loan_type', 'loanType']) || '';
            this.loanType = typeValue.toString();
            this.hasDevelopmentTranches = this.loanType.toLowerCase().includes('development');


            this.renderHeader();
            this.renderSections();
            this.renderCharts();
            this.bindActions();

            loadingEl.classList.add('d-none');
            contentEl.classList.remove('d-none');
        } catch (error) {
            this.showError(error.message);
            throw error;
        }
    }

    showError(message) {
        const loadingEl = document.getElementById('loanDetailLoading');
        const errorEl = document.getElementById('loanDetailError');
        const contentEl = document.getElementById('loanDetailContent');

        loadingEl.classList.add('d-none');
        contentEl.classList.add('d-none');
        errorEl.textContent = message;
        errorEl.classList.remove('d-none');
    }

    renderHeader() {
        if (!this.loanData) return;
        const nameEl = document.getElementById('loanNameDisplay');
        const createdEl = document.getElementById('loanCreatedDisplay');
        const currencyEl = document.getElementById('loanCurrencyDisplay');
        const typeBadge = document.getElementById('loanTypeBadge');


        const displayName = this.getFromSources(['loan_name', 'loanName']) || this.loanName || 'Saved Loan';
        if (nameEl) nameEl.textContent = displayName;

        if (createdEl) {
            const created = this.loanData.created_at ? new Date(this.loanData.created_at.replace(' ', 'T')) : null;
            createdEl.textContent = created ? created.toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' }) : '—';
        }
        if (currencyEl) currencyEl.textContent = `${this.currencySymbol} (${this.currency})`;

        if (typeBadge) typeBadge.textContent = this.formatLoanType(this.loanType || this.loanData.loan_type);


        const docxButton = document.getElementById('downloadDocxButton');
        if (docxButton) {
            docxButton.href = `/loan/${this.loanId}/summary-docx`;
        }
    }

    bindActions() {
        const editButton = document.getElementById('editLoanButton');
        if (editButton) {
            editButton.addEventListener('click', () => {
                const name = encodeURIComponent(this.loanData?.loan_name || this.loanName || 'Saved Loan');
                window.location.href = `/calculator?edit=true&loanId=${this.loanId}&loanName=${name}`;
            });
        }

        const excelButton = document.getElementById('downloadExcelButton');
        if (excelButton) {
            excelButton.addEventListener('click', async () => {
                try {
                    const resp = await fetch(`/generate-working-report/excel/${this.loanId}`);
                    const payload = await resp.json();
                    if (resp.ok && payload.success && payload.download_url) {
                        window.open(payload.download_url, '_blank');
                    } else {
                        throw new Error(payload.error || 'Unable to generate Excel report');
                    }
                } catch (error) {
                    console.error('Excel export failed', error);
                    if (window.notifications?.error) {
                        window.notifications.error(error.message || 'Excel export failed');
                    } else {
                        alert(error.message || 'Excel export failed');
                    }
                }
            });
        }
    }

    renderSections() {
        this.populateTable('loanParametersBody', this.buildLoanParameters());
        this.populateTable('repaymentProfileBody', this.buildRepaymentProfile());
        this.populateTable('feesSectionBody', this.buildFeesSection());
        this.populateTable('loanSummaryBody', this.buildLoanSummary());
    }

    populateTable(tbodyId, rows) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;

        if (!rows || rows.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="2" class="text-center text-muted py-3">No data available</td>
                </tr>
            `;
            return;
        }


        tbody.innerHTML = rows.map(row => `
            <tr>
                <td>${row.label}</td>
                <td>${row.value}</td>
            </tr>
        `).join('');
    }

    buildLoanParameters() {

        const rows = [];
        const name = this.getFromSources(['loan_name', 'loanName']) || this.loanName || '—';
        rows.push({ label: 'Loan Name', value: this.escapeHTML(name) });

        const type = this.getFromSources(['loan_type', 'loanType']);
        rows.push({ label: 'Loan Type', value: this.formatLoanType(type) });

        rows.push({ label: 'Currency', value: `${this.currencySymbol} (${this.currency})` });

        const amountInputType = (this.getFromSources(['amountInputType', 'amount_input_type']) || 'gross').toString().toLowerCase();
        rows.push({ label: 'Amount Input', value: amountInputType === 'net' ? 'Net Amount' : 'Gross Amount' });

        const grossAmount = this.getFromSources(['grossAmount', 'gross_amount', 'gross_amount_value']);
        if (this.hasValue(grossAmount) && (amountInputType !== 'net' || this.toNumber(grossAmount) > 0)) {
            rows.push({ label: 'Gross Amount', value: this.formatCurrency(grossAmount) });
        }

        const netAmount = this.getFromSources(['netAmount', 'net_amount']);
        if (this.hasValue(netAmount)) {
            rows.push({ label: 'Net Amount', value: this.formatCurrency(netAmount) });
        }

        const propertyValue = this.getFromSources(['propertyValue', 'property_value']);
        if (this.hasValue(propertyValue)) {
            rows.push({ label: 'Property Value', value: this.formatCurrency(propertyValue) });
        }

        const interestRate = this.getFromSources(['interestRate', 'interest_rate', 'annual_rate']);
        if (this.hasValue(interestRate)) {
            rows.push({ label: 'Interest Rate (p.a.)', value: this.formatPercent(interestRate) });
        }

        const monthlyRate = this.getFromSources(['monthly_rate', 'monthlyRate']);
        if (this.hasValue(monthlyRate)) {
            rows.push({ label: 'Monthly Rate', value: this.formatPercent(monthlyRate) });
        }

        const interestType = this.getFromSources(['interestType', 'interest_type']);
        if (this.hasValue(interestType)) {
            rows.push({ label: 'Interest Calculation', value: this.formatInterestType(interestType) });
        }

        const startDate = this.getFromSources(['startDate', 'start_date']);
        if (this.hasValue(startDate)) {
            rows.push({ label: 'Start Date', value: this.formatDate(startDate) });
        }

        const endDate = this.getFromSources(['endDate', 'end_date']);
        if (this.hasValue(endDate)) {
            rows.push({ label: 'End Date', value: this.formatDate(endDate) });
        }

        const loanTerm = this.getFromSources(['loanTerm', 'loan_term']);
        if (this.hasValue(loanTerm)) {
            rows.push({ label: 'Loan Term (months)', value: `${this.toNumber(loanTerm, 0)} months` });
        }

        const loanTermDays = this.getFromSources(['loanTermDays', 'loan_term_days']);
        if (this.hasValue(loanTermDays)) {
            rows.push({ label: 'Loan Term (days)', value: `${this.toNumber(loanTermDays, 0)} days` });
        }

        const use360 = this.getFromSources(['use360Days', 'use_360_days']);
        if (use360 !== undefined && use360 !== null) {
            rows.push({ label: '360 Day Method', value: this.formatBoolean(use360) });
        }

        const day1Advance = this.getFromSources(['day1Advance', 'day1_advance', 'userInputDay1Advance', 'user_input_day_1_advance']);
        if (this.hasValue(day1Advance) && this.toNumber(day1Advance) !== 0) {
            rows.push({ label: 'Day 1 Advance', value: this.formatCurrency(day1Advance) });
        }

        const ltvTarget = this.getFromSources(['ltvTarget', 'ltv_target']);
        if (this.hasValue(ltvTarget) && this.toNumber(ltvTarget) > 0) {
            rows.push({ label: 'Target LTV', value: this.formatPercent(ltvTarget) });
        }

        return rows;
    }

    buildRepaymentProfile() {
        const rows = [];

        const option = this.getFromSources(['repaymentOption', 'repayment_option']);
        if (this.hasValue(option)) {
            rows.push({ label: 'Repayment Option', value: this.formatRepaymentOption(option) });
        }

        const interestServicing = this.getFromSources(['interestServicing', 'interest_servicing', 'interestPaymentType', 'interest_payment_type']);
        if (this.hasValue(interestServicing)) {
            rows.push({
                label: 'Interest Payment Type',
                value: this.capitalize(String(interestServicing).replace(/[_-]/g, ' '))
            });
        }

        const paymentTiming = this.getFromSources(['paymentTiming', 'payment_timing']);
        if (this.hasValue(paymentTiming)) {
            let label = this.capitalize(paymentTiming);
            if (paymentTiming === 'advance') label = 'In Advance';
            if (paymentTiming === 'arrears') label = 'In Arrears';
            rows.push({ label: 'Payment Timing', value: label });
        }

        const paymentFrequency = this.getFromSources(['paymentFrequency', 'payment_frequency']);
        if (this.hasValue(paymentFrequency)) {
            rows.push({ label: 'Payment Frequency', value: this.capitalize(paymentFrequency) });
        }

        const monthlyPayment = this.getFromSources(['monthlyPayment', 'monthly_payment']);
        if (this.hasValue(monthlyPayment) && this.toNumber(monthlyPayment) !== 0) {
            rows.push({ label: 'Monthly Payment', value: this.formatCurrency(monthlyPayment) });
        }

        const quarterlyPayment = this.getFromSources(['quarterlyPayment', 'quarterly_payment']);
        if (this.hasValue(quarterlyPayment) && this.toNumber(quarterlyPayment) !== 0) {
            rows.push({ label: 'Quarterly Payment', value: this.formatCurrency(quarterlyPayment) });
        }

        const monthlyInterest = this.getFromSources(['monthlyInterestPayment', 'monthly_interest_payment']);
        if (this.hasValue(monthlyInterest) && this.toNumber(monthlyInterest) !== 0) {
            rows.push({ label: 'Monthly Interest Payment', value: this.formatCurrency(monthlyInterest) });
        }

        const quarterlyInterest = this.getFromSources(['quarterlyInterestPayment', 'quarterly_interest_payment']);
        if (this.hasValue(quarterlyInterest) && this.toNumber(quarterlyInterest) !== 0) {
            rows.push({ label: 'Quarterly Interest Payment', value: this.formatCurrency(quarterlyInterest) });
        }

        const capitalRepayment = this.getFromSources(['capitalRepayment', 'capital_repayment']);
        if (this.hasValue(capitalRepayment) && this.toNumber(capitalRepayment) !== 0) {
            rows.push({ label: 'Capital Repayment', value: this.formatCurrency(capitalRepayment) });
        }

        const flexiblePayment = this.getFromSources(['flexiblePayment', 'flexible_payment']);
        if (this.hasValue(flexiblePayment) && this.toNumber(flexiblePayment) !== 0) {
            rows.push({ label: 'Flexible Payment', value: this.formatCurrency(flexiblePayment) });
        }

        return rows;
    }

    buildFeesSection() {
        const rows = [];

        const arrangementPercent = this.getFromSources(['arrangementFeePercentage', 'arrangement_fee_percentage']);
        if (this.hasValue(arrangementPercent)) {
            rows.push({ label: 'Arrangement Fee %', value: this.formatPercent(arrangementPercent) });
        }

        const arrangementFee = this.getFromSources(['arrangementFee', 'arrangement_fee']);
        if (this.hasValue(arrangementFee)) {
            rows.push({ label: 'Arrangement Fee', value: this.formatCurrency(arrangementFee) });
        }

        const legalFees = this.getFromSources(['legalFees', 'legal_fees', 'legal_costs']);
        if (this.hasValue(legalFees)) {
            rows.push({ label: 'Legal Fees', value: this.formatCurrency(legalFees) });
        }

        const siteVisitFee = this.getFromSources(['siteVisitFee', 'site_visit_fee']);
        if (this.hasValue(siteVisitFee)) {
            rows.push({ label: 'Site Visit Fee', value: this.formatCurrency(siteVisitFee) });
        }

        const titleInsurance = this.getFromSources(['titleInsurance', 'title_insurance']);
        if (this.hasValue(titleInsurance)) {
            rows.push({ label: 'Title Insurance', value: this.formatCurrency(titleInsurance) });
        }

        const brokerFeePercent = this.getFromSources(['brokerFeePercentage', 'broker_fee_percentage']);
        if (this.hasValue(brokerFeePercent)) {
            rows.push({ label: 'Broker Fee %', value: this.formatPercent(brokerFeePercent) });
        }

        const brokerFee = this.getFromSources(['brokerFee', 'broker_fee']);
        if (this.hasValue(brokerFee) && this.toNumber(brokerFee) !== 0) {
            rows.push({ label: 'Broker Fee', value: this.formatCurrency(brokerFee) });
        }

        const exitFeePercent = this.getFromSources(['exitFeePercentage', 'exit_fee_percentage', 'exit_fee_percent']);
        if (this.hasValue(exitFeePercent)) {
            rows.push({ label: 'Exit Fee %', value: this.formatPercent(exitFeePercent) });
        }

        const exitFee = this.getFromSources(['exitFee', 'exit_fee']);
        if (this.hasValue(exitFee) && this.toNumber(exitFee) !== 0) {
            rows.push({ label: 'Exit Fee', value: this.formatCurrency(exitFee) });
        }

        return rows;
    }

    buildLoanSummary() {
        const rows = [];

        const valuation = this.getFromSources(['propertyValue', 'property_value']);
        if (this.hasValue(valuation)) {
            rows.push({ label: 'Valuation', value: this.formatCurrency(valuation) });
        }

        const grossAmount = this.getFromSources(['grossAmount', 'gross_amount']);
        if (this.hasValue(grossAmount)) {
            rows.push({ label: 'Gross Amount', value: this.formatCurrency(grossAmount) });
        }

        const netAdvance = this.getFromSources(['netAdvance', 'net_advance']);
        if (this.hasValue(netAdvance)) {
            rows.push({ label: 'Net Advance', value: this.formatCurrency(netAdvance) });
        }

        const totalNetAdvance = this.getFromSources(['totalNetAdvance', 'total_net_advance']);
        if (this.hasValue(totalNetAdvance)) {
            rows.push({ label: 'Total Net Advance', value: this.formatCurrency(totalNetAdvance) });
        }

        const totalInterest = this.getFromSources(['totalInterest', 'total_interest']);
        if (this.hasValue(totalInterest)) {
            rows.push({ label: 'Total Interest', value: this.formatCurrency(totalInterest) });
        }

        const retainedInterest = this.getFromSources(['retainedInterest', 'retained_interest']);
        if (this.hasValue(retainedInterest) && this.toNumber(retainedInterest) !== 0) {
            rows.push({ label: 'Retained Interest', value: this.formatCurrency(retainedInterest) });
        }

        const interestSavings = this.getFromSources(['interestSavings', 'interest_savings']);
        if (this.hasValue(interestSavings) && this.toNumber(interestSavings) !== 0) {
            rows.push({ label: 'Interest Savings', value: this.formatCurrency(interestSavings) });
        }

        const savingsPercentage = this.getFromSources(['savingsPercentage', 'savings_percentage']);
        if (this.hasValue(savingsPercentage) && this.toNumber(savingsPercentage) !== 0) {
            rows.push({ label: 'Savings %', value: this.formatPercent(savingsPercentage) });
        }

        const startLtv = this.getFromSources(['startLtv', 'start_ltv', 'ltvRatio', 'ltv_ratio']);
        if (this.hasValue(startLtv) && this.toNumber(startLtv) >= 0) {
            rows.push({ label: 'Start LTV', value: this.formatPercent(startLtv) });
        }

        const endLtv = this.getFromSources(['endLtv', 'end_ltv']);
        if (this.hasValue(endLtv) && this.toNumber(endLtv) >= 0) {
            rows.push({ label: 'End LTV', value: this.formatPercent(endLtv) });
        }

        const totalCost = this.getFromSources(['totalCost', 'total_cost']);
        if (this.hasValue(totalCost) && this.toNumber(totalCost) !== 0) {
            rows.push({ label: 'Total Cost of Finance', value: this.formatCurrency(totalCost) });
        }

        return rows;

    }

    renderCharts() {
        const breakdownCanvas = document.getElementById('loanBreakdownChart');
        if (breakdownCanvas && this.loanData) {
            this.renderLoanBreakdownChart(breakdownCanvas);
        }


        const chartCards = ['interestPrincipalCard', 'paymentScheduleCard', 'balanceChartCard'];

        if (window.chartManager && this.scheduleData.length > 0) {
            const interestChart = chartManager.createInterestBreakdownChart('interestPrincipalChart', this.scheduleData, {
                currency: this.currencySymbol
            });
            this.applyChartTheme(interestChart, { includeScales: false });

            const paymentChart = chartManager.createPaymentScheduleChart('paymentScheduleChart', this.scheduleData, {
                currency: this.currencySymbol
            });
            this.applyChartTheme(paymentChart);

            const balanceChart = chartManager.createLoanBalanceChart('balanceChart', this.scheduleData, {
                currency: this.currencySymbol
            });
            this.applyChartTheme(balanceChart);
            chartCards.forEach(id => document.getElementById(id)?.classList.remove('d-none'));
        } else {
            chartCards.forEach(id => {

                const el = document.getElementById(id);
                if (el) el.classList.add('d-none');
            });
        }


        const ltvCard = document.getElementById('ltvChartCard');
        if (ltvCard) {
            const ltvValue = this.toNumber(this.getFromSources(['endLtv', 'end_ltv', 'ltvRatio', 'ltv_ratio']), NaN);
            if (window.chartManager && Number.isFinite(ltvValue) && ltvValue > 0) {
                ltvCard.classList.remove('d-none');
                const ltvChart = chartManager.createLTVChart('loanLtvChart', ltvValue, {});
                this.applyChartTheme(ltvChart, { includeScales: false });
            } else {
                ltvCard.classList.add('d-none');
            }
        }

        const trancheCard = document.getElementById('trancheReleaseCard');
        if (trancheCard) {
            trancheCard.classList.add('d-none');
        }
        if (this.hasDevelopmentTranches) {
            const trancheData = this.getTrancheDataset();

            if (trancheData.length > 0) {
                this.renderTrancheReleaseChart(trancheData);
            }
        }
    }

    renderLoanBreakdownChart(canvas) {
        if (!canvas || !this.loanData) return;

        const dataset = [
            { label: 'Total Net Advance', value: this.loanData.totalNetAdvance || 0 },
            { label: 'Arrangement Fee', value: this.loanData.arrangementFee || 0 },
            { label: 'Legal Costs', value: this.loanData.legalFees || 0 },
            { label: 'Site Visit Fee', value: this.loanData.siteVisitFee || 0 },
            { label: 'Title Insurance', value: this.loanData.titleInsurance || 0 },
            { label: 'Total Interest', value: this.loanData.totalInterest || 0 }
        ];

        const dataValues = dataset.map(item => item.value || 0);
        if (dataValues.every(val => val === 0)) {
            const card = canvas.closest('.card');
            if (card) {
                card.querySelector('.card-body').innerHTML = '<div class="text-center text-muted">Breakdown data not available.</div>';
            }
            return;
        }

        if (canvas.chartInstance) {
            canvas.chartInstance.destroy();
        }

        canvas.chartInstance = new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: dataset.map(item => item.label),
                datasets: [{
                    data: dataValues,
                    backgroundColor: ['#0b0b16', '#b49b5c', '#ffffff', '#3a3a3a', '#6b6b6b', '#9e9e9e'],
                    borderColor: '#0b0b16',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: '#f8f9fa' }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((sum, item) => sum + item, 0);
                                const percentage = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${label}: ${this.currencySymbol}${value.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    renderTrancheReleaseChart(trancheData) {
        const card = document.getElementById('trancheReleaseCard');
        const canvas = document.getElementById('trancheReleaseChart');
        if (!card || !canvas) return;

        card.classList.remove('d-none');

        if (canvas.chartInstance) {
            canvas.chartInstance.destroy();
        }

        const labels = trancheData.map(entry => `Period ${entry.period}`);
        const values = trancheData.map(entry => entry.tranche_release);

        canvas.chartInstance = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Tranche Release',
                    data: values,
                    backgroundColor: 'rgba(180, 155, 92, 0.65)',
                    borderColor: '#b49b5c',
                    borderWidth: 1.5,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${this.currencySymbol}${context.parsed.y.toLocaleString('en-GB', { minimumFractionDigits: 2 })}`
                        }
                    }
                },
                scales: {
                    x: {

                        ticks: { color: '#f8f9fa' },

                        grid: { color: 'rgba(255,255,255,0.06)' }
                    },
                    y: {
                        ticks: {

                            color: '#f8f9fa',

                            callback: (value) => `${this.currencySymbol}${Number(value).toLocaleString('en-GB')}`
                        },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    }
                }
            }
        });
    }


    parseScheduleData(rawSchedule = []) {
        return rawSchedule.map((entry = {}, index) => {
            const getValue = (...keys) => {
                for (const key of keys) {
                    if (entry[key] !== undefined && entry[key] !== null && entry[key] !== '') {
                        return entry[key];
                    }
                }
                return undefined;
            };

            return {
                period: this.toNumber(getValue('period_number', 'period', 'index'), index + 1),
                interest: this.toNumber(getValue('interest_payment', 'interest_amount', 'interest')),
                principal: this.toNumber(getValue('principal_payment', 'principal')),
                balance: this.toNumber(getValue('closing_balance', 'balance', 'outstanding_balance')),
                tranche_release: this.toNumber(getValue('tranche_release', 'tranche', 'drawdown', 'drawdown_amount')),
                interest_accrued: this.toNumber(getValue('interest_accrued', 'interest_calculation')),
                total_payment: this.toNumber(getValue('total_payment', 'payment_total'))

            };
        });
    }

    formatCurrency(value) {

        const num = this.normalizeNumber(value);

        if (!Number.isFinite(num)) return '—';
        return `${this.currencySymbol}${num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }


    formatNumber(value, decimals = 2) {
        const num = this.normalizeNumber(value);
        if (!Number.isFinite(num)) {
            return Number(decimals) === 0 ? '0' : '0.00';
        }
        return num.toLocaleString('en-GB', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    formatPercent(value, decimals = 2) {
        const num = this.normalizeNumber(value);
        if (!Number.isFinite(num)) return '—';
        return `${num.toLocaleString('en-GB', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        })}%`;

    }

    formatDate(value) {
        if (!value) return '—';

        let date = value instanceof Date ? value : null;
        if (!date) {
            if (typeof value === 'string' && value.includes('/')) {
                const parts = value.split(/[\/-]/).map(part => Number(part));
                if (parts.length === 3 && parts.every(Number.isFinite)) {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            if (!date) {
                date = new Date(value);
            }
        }

        if (Number.isNaN(date.getTime())) {
            return value;
        }
        return date.toLocaleDateString('en-GB');
    }

    formatLoanType(type) {
        if (!type) return '—';

        const normalized = type.toString().toLowerCase();
        const mapping = {
            bridge: 'Bridge',
            term: 'Term',
            development: 'Development',
            development2: 'Development',
            development_finance: 'Development Finance',
            bridge_refurbishment: 'Bridge - Refurbishment'
        };
        return mapping[normalized] || this.capitalize(normalized.replace(/[_-]/g, ' '));

    }

    formatRepaymentOption(option) {
        if (!option) return '—';
        const mapping = {

            none: 'Interest Retained',
            interest_only: 'Interest Only',
            capital_and_interest: 'Capital & Interest',
            capital: 'Capital Only',
            capital_payment_only: 'Capital Only',
            flexible: 'Flexible',
            flexible_payment: 'Flexible Payment',
            term_interest_only: 'Term Interest Only',
            development_roll_up: 'Development Roll Up',
            service_only: 'Interest Serviced',
            service_and_capital: 'Service & Capital',
            roll_up: 'Roll Up'

        };
        return mapping[option] || this.capitalize(option.replace(/[_-]/g, ' '));
    }


    formatInterestType(type) {
        if (!type) return '—';
        const mapping = {
            simple: 'Simple',
            retained: 'Retained',
            compound_daily: 'Compound (Daily)',
            compound_monthly: 'Compound (Monthly)',
            compound_quarterly: 'Compound (Quarterly)',
            daily: 'Daily',
            monthly: 'Monthly',
            quarterly: 'Quarterly'
        };
        const normalized = type.toString().toLowerCase();
        return mapping[normalized] || this.capitalize(normalized.replace(/[_-]/g, ' '));
    }

    formatBoolean(value) {
        return this.coerceBoolean(value) ? 'Yes' : 'No';
    }


    capitalize(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }


    applyChartTheme(chart, { includeScales = true } = {}) {
        if (!chart || !chart.options) return;

        const { options } = chart;
        const legendLabels = options.plugins?.legend?.labels;
        if (legendLabels) {
            legendLabels.color = '#f8f9fa';
        }

        if (options.plugins?.title) {
            options.plugins.title.color = '#f8f9fa';
        }

        if (includeScales && options.scales) {
            Object.values(options.scales).forEach(scale => {
                if (!scale) return;
                if (scale.ticks) {
                    scale.ticks.color = '#f8f9fa';
                }
                if (scale.title) {
                    scale.title.color = '#f8f9fa';
                }
                if (scale.grid && scale.grid.color) {
                    scale.grid.color = 'rgba(255,255,255,0.08)';
                }
            });
        }

        chart.update('none');
    }

    coerceBoolean(value) {
        if (typeof value === 'boolean') return value;
        if (typeof value === 'number') return value !== 0;
        if (typeof value === 'string') {
            const normalized = value.trim().toLowerCase();
            if (['true', 'yes', 'y', '1', 'on'].includes(normalized)) return true;
            if (['false', 'no', 'n', '0', 'off'].includes(normalized)) return false;
        }
        return Boolean(value);
    }

    getFromSources(keys, defaultValue) {
        const keyList = Array.isArray(keys) ? keys : [keys];
        const sources = [this.loanData || {}, this.inputData || {}];
        for (const key of keyList) {
            for (const source of sources) {
                if (!source) continue;
                if (Object.prototype.hasOwnProperty.call(source, key)) {
                    const value = source[key];
                    if (this.hasValue(value) || value === 0 || value === false) {
                        return value;
                    }
                }
            }
        }
        return defaultValue;
    }

    hasValue(value) {
        if (value === undefined || value === null) {
            return false;
        }
        if (typeof value === 'string') {
            return value.trim() !== '';
        }
        return true;
    }

    normalizeNumber(value) {
        if (typeof value === 'number') {
            return value;
        }
        if (typeof value === 'string') {
            const cleaned = value.replace(/[^0-9.-]/g, '');
            if (cleaned === '' || cleaned === '-' || cleaned === '.' || cleaned === '-.') {
                return NaN;
            }
            const parsed = parseFloat(cleaned);
            return Number.isFinite(parsed) ? parsed : NaN;
        }
        if (value instanceof Date) {
            return value.getTime();
        }
        if (typeof value === 'boolean') {
            return value ? 1 : 0;
        }
        if (value !== undefined && value !== null && Number.isFinite(Number(value))) {
            return Number(value);
        }
        return NaN;
    }

    toNumber(value, defaultValue = 0) {
        const num = this.normalizeNumber(value);
        return Number.isFinite(num) ? num : defaultValue;
    }

    getTrancheDataset() {
        const dataset = [];
        const detailed = Array.isArray(this.loanData?.detailed_tranche_schedule)
            ? this.loanData.detailed_tranche_schedule
            : [];

        if (detailed.length > 0) {
            detailed.forEach((entry, index) => {
                const amount = this.toNumber(
                    entry?.tranche_release ?? entry?.amount ?? entry?.drawdown ?? entry?.release_amount,
                    NaN
                );
                if (!Number.isFinite(amount) || amount === 0) {
                    return;
                }
                const periodValue = entry?.period ?? entry?.period_number ?? entry?.month ?? index + 1;
                dataset.push({ period: periodValue, tranche_release: amount });
            });
        }

        if (dataset.length === 0 && Array.isArray(this.scheduleData)) {
            this.scheduleData.forEach(entry => {
                if (!entry) return;
                const amount = this.toNumber(entry.tranche_release, NaN);
                if (!Number.isFinite(amount) || amount === 0) return;
                dataset.push({ period: entry.period, tranche_release: amount });
            });
        }

        return dataset;
    }


    escapeHTML(value) {
        return String(value).replace(/[&<>"']/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[char]);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new LoanHistoryDetailPage({
        loanId: {{ loan_id }},
        loanName: {{ loan_name | tojson }}
    });
});
</script>
{% endblock %}
