{% extends "base.html" %}

{% block title %}Loan History Details{% endblock %}

{% block body_attr %}class="gold-nav"{% endblock %}

{% block nav_heading %}<span class="navbar-text text-white text-center fw-bold"><i class="fas fa-eye me-2"></i>Loan History Details</span>{% endblock %}

{% block head %}
<link href="{{ url_for('static', filename='css/novellus-theme.css') }}" rel="stylesheet"/>
<link rel="stylesheet" href="{{ url_for('static', filename='css/currency-themes.css') }}">
{% endblock %}

{% macro currency(value) %}
    {{ loan.currency_symbol }}{{ "{:,.2f}".format(value or 0) }}
{% endmacro %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <a href="{{ url_for('loan_history') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Loan History
        </a>
        <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-primary" href="{{ url_for('download_loan_summary_docx', loan_id=loan.id) }}" target="_blank">
                <i class="fas fa-file-word me-1"></i>Download DOCX
            </a>
            <a class="btn btn-novellus-gold" href="/calculator?edit=true&loanId={{ loan.id }}&loanName={{ loan.loan_name|urlencode }}">
                <i class="fas fa-edit me-1"></i>Edit &amp; Recalculate
            </a>
        </div>
    </div>

        <div class="col-12 col-xl-8">
            <div class="row row-cols-1 row-cols-lg-2 g-4">
                <div class="col">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light fw-bold"><i class="fas fa-list me-2"></i>Loan Parameters</div>
                        <div class="card-body p-0">
                            <table class="table mb-0">
                                <tbody>
                                    <tr>
                                        <th class="w-50">Loan Name</th>
                                        <td>{{ loan.loan_name_input }}</td>
                                    </tr>
                                    <tr>
                                        <th>Loan Type</th>
                                        <td>{{ loan.loan_type_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>Currency</th>
                                        <td>{{ loan.currency_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Property Value</th>
                                        <td>{{ currency(loan.property_value_input or loan.property_value) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Amount Input</th>
                                        <td>{{ loan.amount_input_type_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>Gross Amount</th>
                                        <td>{{ currency(loan.gross_amount_input or loan.gross_amount) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Gross Amount Type</th>
                                        <td>{{ loan.gross_amount_type_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>Gross % of Property</th>
                                        <td>
                                            {% if loan.gross_amount_percentage_input %}
                                                {{ "{:.2f}".format(loan.gross_amount_percentage_input) }}%
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Net Amount</th>
                                        <td>{{ currency(loan.net_amount_input or loan.net_amount) }}</td>
                                    </tr>
                                    {% if loan.user_input_day1_advance_input %}
                                    <tr>
                                        <th>Day 1 Advance (Input)</th>
                                        <td>{{ currency(loan.user_input_day1_advance_input) }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if loan.day1_advance and loan.day1_advance != loan.user_input_day1_advance_input %}
                                    <tr>
                                        <th>Day 1 Advance (Calculated)</th>
                                        <td>{{ currency(loan.day1_advance) }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr>
                                        <th>Loan End Type</th>
                                        <td>{{ loan.loan_end_type_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>Start Date</th>
                                        <td>{{ loan.start_date_input_display or '—' }}</td>
                                    </tr>
                                    <tr>
                                        <th>End Date</th>
                                        <td>{{ loan.end_date_input_display or '—' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Loan Term (Months)</th>
                                        <td>{{ loan.loan_term_input or loan.loan_term or '—' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Loan Term (Days)</th>
                                        <td>{{ loan.loan_term_days or '—' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Use 360-Day Rate</th>
                                        <td>{{ loan.use_360_days_label }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light fw-bold"><i class="fas fa-chart-line me-2"></i>Repayment Profile</div>
                        <div class="card-body p-0">
                            <table class="table mb-0">
                                <tbody>
                                    <tr>
                                        <th class="w-50">Repayment Option</th>
                                        <td>{{ loan.repayment_option_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>Interest Calculation</th>
                                        <td>{{ loan.interest_type_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>{{ loan.rate_input_type_label }}</th>
                                        <td>
                                            {% if loan.rate_input_type == 'monthly' %}
                                                {{ "{:.4f}".format(loan.monthly_rate_input) }}%
                                            {% else %}
                                                {{ "{:.2f}".format(loan.annual_rate_input) }}%
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% if loan.rate_input_type == 'monthly' %}
                                    <tr>
                                        <th>Annual Equivalent Rate</th>
                                        <td>{{ "{:.2f}".format(loan.annual_rate_input) }}%</td>
                                    </tr>
                                    {% endif %}
                                    <tr>
                                        <th>Payment Timing</th>
                                        <td>{{ loan.payment_timing_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>Payment Frequency</th>
                                        <td>{{ loan.payment_frequency_label }}</td>
                                    </tr>
                                    <tr>
                                        <th>Capital Repayment</th>
                                        <td>{{ currency(loan.capital_repayment_input or loan.capital_repayment) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Flexible Payment</th>
                                        <td>{{ currency(loan.flexible_payment_input or loan.flexible_payment) }}</td>
                                    </tr>
                                    <tr>
                                        <th>LTV Target</th>
                                        <td>
                                            {% if loan.ltv_target %}
                                                {{ "{:.2f}".format(loan.ltv_target) }}%
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light fw-bold"><i class="fas fa-coins me-2"></i>Fees Section</div>
                        <div class="card-body p-0">
                            <table class="table mb-0">
                                <tbody>
                                    <tr>
                                        <th class="w-50">Arrangement Fee %</th>
                                        <td>{{ "{:.2f}".format(loan.arrangement_fee_percentage_input) }}%</td>
                                    </tr>
                                    <tr>
                                        <th>Arrangement Fee</th>
                                        <td>{{ currency(loan.arrangement_fee) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Legal Fees</th>
                                        <td>{{ currency(loan.legal_fees_input or loan.legal_costs) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Site Visit Fee</th>
                                        <td>{{ currency(loan.site_visit_fee_input or loan.site_visit_fee) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Title Insurance %</th>
                                        <td>
                                            {% if loan.title_insurance_rate_input %}
                                                {{ "{:.4f}".format(loan.title_insurance_rate_input) }}%
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Title Insurance</th>
                                        <td>{{ currency(loan.title_insurance) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Total Fees</th>
                                        <td>{{ currency(loan.arrangement_fee + loan.legal_costs + loan.site_visit_fee + loan.title_insurance) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-light fw-bold"><i class="fas fa-calculator me-2"></i>Loan Summary</div>
                        <div class="card-body p-0">
                            <table class="table mb-0">
                                <tbody>
                                    <tr>
                                        <th class="w-50">Property Value</th>
                                        <td>{{ currency(loan.property_value) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Gross Amount</th>
                                        <td>{{ currency(loan.gross_amount) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Net Amount</th>
                                        <td>{{ currency(loan.net_amount) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Net Advance</th>
                                        <td>{{ currency(loan.net_advance) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Total Net Advance</th>
                                        <td>{{ currency(loan.total_net_advance) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Total Interest</th>
                                        <td>{{ currency(loan.total_interest) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Monthly Payment</th>
                                        <td>{{ currency(loan.monthly_payment) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Quarterly Payment</th>
                                        <td>{{ currency(loan.quarterly_payment) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Monthly Interest Payment</th>
                                        <td>{{ currency(loan.monthly_interest_payment) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Quarterly Interest Payment</th>
                                        <td>{{ currency(loan.quarterly_interest_payment) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Day 1 Advance</th>
                                        <td>{{ currency(loan.day1_advance) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Start LTV</th>
                                        <td>{{ "{:.2f}".format(loan.start_ltv) }}%</td>
                                    </tr>
                                    <tr>
                                        <th>End LTV</th>
                                        <td>{{ "{:.2f}".format(loan.end_ltv) }}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-5">
        <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
            <span><i class="fas fa-table me-2"></i>Payment Schedule</span>
            <span class="text-muted small">{{ loan.payment_schedule|length }} periods</span>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Period</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Days Held</th>
                        <th>Payment Date</th>
                        <th class="text-end">Opening Balance</th>
                        <th class="text-end">Tranche Release</th>
                        <th>Calculation</th>
                        <th class="text-end">Interest</th>
                        <th class="text-end">Principal</th>
                        <th class="text-end">Total Payment</th>
                        <th class="text-end">Closing Balance</th>
                        <th class="text-end">Balance Change</th>
                        <th class="text-end">Running LTV</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in loan.payment_schedule %}
                    <tr>
                        <td>{{ row.period }}</td>
                        <td>{{ row.start_period or '—' }}</td>
                        <td>{{ row.end_period or '—' }}</td>
                        <td>{{ row.days_held or '—' }}</td>
                        <td>{{ row.payment_date or '—' }}</td>
                        <td class="text-end">{{ row.opening_balance }}</td>
                        <td class="text-end">{{ row.tranche_release }}</td>
                        <td>{{ row.interest_calculation }}</td>
                        <td class="text-end text-danger">{{ row.interest_amount }}</td>
                        <td class="text-end text-primary">{{ row.principal_payment }}</td>
                        <td class="text-end fw-semibold">{{ row.total_payment }}</td>
                        <td class="text-end">{{ row.closing_balance }}</td>
                        <td class="text-end">{{ row.balance_change }}</td>
                        <td class="text-end">{{ row.running_ltv or '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}
